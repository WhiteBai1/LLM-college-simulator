/*! For license information please see app.bundle.js.LICENSE.txt */
(()=>{var t={377:(t,e,n)=>{var i=n(832),r=n(652),o=n(801),s=n(30),a=n(618),c=n(49),l=n(971);l.alea=i,l.xor128=r,l.xorwow=o,l.xorshift7=s,l.xor4096=a,l.tychei=c,t.exports=l},832:function(t,e,n){var i;!function(t,r,o){function s(t){var e=this,n=function(){var t=4022871197,e=function(e){e=String(e);for(var n=0;n<e.length;n++){var i=.02519603282416938*(t+=e.charCodeAt(n));i-=t=i>>>0,t=(i*=t)>>>0,t+=4294967296*(i-=t)}return 2.3283064365386963e-10*(t>>>0)};return e}();e.next=function(){var t=2091639*e.s0+2.3283064365386963e-10*e.c;return e.s0=e.s1,e.s1=e.s2,e.s2=t-(e.c=0|t)},e.c=1,e.s0=n(" "),e.s1=n(" "),e.s2=n(" "),e.s0-=n(t),e.s0<0&&(e.s0+=1),e.s1-=n(t),e.s1<0&&(e.s1+=1),e.s2-=n(t),e.s2<0&&(e.s2+=1),n=null}function a(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}function c(t,e){var n=new s(t),i=e&&e.state,r=n.next;return r.int32=function(){return 4294967296*n.next()|0},r.double=function(){return r()+11102230246251565e-32*(2097152*r()|0)},r.quick=r,i&&("object"==typeof i&&a(i,n),r.state=function(){return a(n,{})}),r}r&&r.exports?r.exports=c:n.amdD&&n.amdO?void 0===(i=function(){return c}.call(e,n,e,r))||(r.exports=i):this.alea=c}(0,t=n.nmd(t),n.amdD)},49:function(t,e,n){var i;!function(t,r,o){function s(t){var e=this,n="";e.next=function(){var t=e.b,n=e.c,i=e.d,r=e.a;return t=t<<25^t>>>7^n,n=n-i|0,i=i<<24^i>>>8^r,r=r-t|0,e.b=t=t<<20^t>>>12^n,e.c=n=n-i|0,e.d=i<<16^n>>>16^r,e.a=r-t|0},e.a=0,e.b=0,e.c=-1640531527,e.d=1367130551,t===Math.floor(t)?(e.a=t/4294967296|0,e.b=0|t):n+=t;for(var i=0;i<n.length+20;i++)e.b^=0|n.charCodeAt(i),e.next()}function a(t,e){return e.a=t.a,e.b=t.b,e.c=t.c,e.d=t.d,e}function c(t,e){var n=new s(t),i=e&&e.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},r.int32=n.next,r.quick=r,i&&("object"==typeof i&&a(i,n),r.state=function(){return a(n,{})}),r}r&&r.exports?r.exports=c:n.amdD&&n.amdO?void 0===(i=function(){return c}.call(e,n,e,r))||(r.exports=i):this.tychei=c}(0,t=n.nmd(t),n.amdD)},652:function(t,e,n){var i;!function(t,r,o){function s(t){var e=this,n="";e.x=0,e.y=0,e.z=0,e.w=0,e.next=function(){var t=e.x^e.x<<11;return e.x=e.y,e.y=e.z,e.z=e.w,e.w^=e.w>>>19^t^t>>>8},t===(0|t)?e.x=t:n+=t;for(var i=0;i<n.length+64;i++)e.x^=0|n.charCodeAt(i),e.next()}function a(t,e){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}function c(t,e){var n=new s(t),i=e&&e.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},r.int32=n.next,r.quick=r,i&&("object"==typeof i&&a(i,n),r.state=function(){return a(n,{})}),r}r&&r.exports?r.exports=c:n.amdD&&n.amdO?void 0===(i=function(){return c}.call(e,n,e,r))||(r.exports=i):this.xor128=c}(0,t=n.nmd(t),n.amdD)},618:function(t,e,n){var i;!function(t,r,o){function s(t){var e=this;e.next=function(){var t,n,i=e.w,r=e.X,o=e.i;return e.w=i=i+1640531527|0,n=r[o+34&127],t=r[o=o+1&127],n^=n<<13,t^=t<<17,n^=n>>>15,t^=t>>>12,n=r[o]=n^t,e.i=o,n+(i^i>>>16)|0},function(t,e){var n,i,r,o,s,a=[],c=128;for(e===(0|e)?(i=e,e=null):(e+="\0",i=0,c=Math.max(c,e.length)),r=0,o=-32;o<c;++o)e&&(i^=e.charCodeAt((o+32)%e.length)),0===o&&(s=i),i^=i<<10,i^=i>>>15,i^=i<<4,i^=i>>>13,o>=0&&(s=s+1640531527|0,r=0==(n=a[127&o]^=i+s)?r+1:0);for(r>=128&&(a[127&(e&&e.length||0)]=-1),r=127,o=512;o>0;--o)i=a[r+34&127],n=a[r=r+1&127],i^=i<<13,n^=n<<17,i^=i>>>15,n^=n>>>12,a[r]=i^n;t.w=s,t.X=a,t.i=r}(e,t)}function a(t,e){return e.i=t.i,e.w=t.w,e.X=t.X.slice(),e}function c(t,e){null==t&&(t=+new Date);var n=new s(t),i=e&&e.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},r.int32=n.next,r.quick=r,i&&(i.X&&a(i,n),r.state=function(){return a(n,{})}),r}r&&r.exports?r.exports=c:n.amdD&&n.amdO?void 0===(i=function(){return c}.call(e,n,e,r))||(r.exports=i):this.xor4096=c}(0,t=n.nmd(t),n.amdD)},30:function(t,e,n){var i;!function(t,r,o){function s(t){var e=this;e.next=function(){var t,n,i=e.x,r=e.i;return t=i[r],n=(t^=t>>>7)^t<<24,n^=(t=i[r+1&7])^t>>>10,n^=(t=i[r+3&7])^t>>>3,n^=(t=i[r+4&7])^t<<7,t=i[r+7&7],n^=(t^=t<<13)^t<<9,i[r]=n,e.i=r+1&7,n},function(t,e){var n,i=[];if(e===(0|e))i[0]=e;else for(e=""+e,n=0;n<e.length;++n)i[7&n]=i[7&n]<<15^e.charCodeAt(n)+i[n+1&7]<<13;for(;i.length<8;)i.push(0);for(n=0;n<8&&0===i[n];++n);for(8==n?i[7]=-1:i[n],t.x=i,t.i=0,n=256;n>0;--n)t.next()}(e,t)}function a(t,e){return e.x=t.x.slice(),e.i=t.i,e}function c(t,e){null==t&&(t=+new Date);var n=new s(t),i=e&&e.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},r.int32=n.next,r.quick=r,i&&(i.x&&a(i,n),r.state=function(){return a(n,{})}),r}r&&r.exports?r.exports=c:n.amdD&&n.amdO?void 0===(i=function(){return c}.call(e,n,e,r))||(r.exports=i):this.xorshift7=c}(0,t=n.nmd(t),n.amdD)},801:function(t,e,n){var i;!function(t,r,o){function s(t){var e=this,n="";e.next=function(){var t=e.x^e.x>>>2;return e.x=e.y,e.y=e.z,e.z=e.w,e.w=e.v,(e.d=e.d+362437|0)+(e.v=e.v^e.v<<4^t^t<<1)|0},e.x=0,e.y=0,e.z=0,e.w=0,e.v=0,t===(0|t)?e.x=t:n+=t;for(var i=0;i<n.length+64;i++)e.x^=0|n.charCodeAt(i),i==n.length&&(e.d=e.x<<10^e.x>>>4),e.next()}function a(t,e){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e.v=t.v,e.d=t.d,e}function c(t,e){var n=new s(t),i=e&&e.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},r.int32=n.next,r.quick=r,i&&("object"==typeof i&&a(i,n),r.state=function(){return a(n,{})}),r}r&&r.exports?r.exports=c:n.amdD&&n.amdO?void 0===(i=function(){return c}.call(e,n,e,r))||(r.exports=i):this.xorwow=c}(0,t=n.nmd(t),n.amdD)},971:function(t,e,n){var i;!function(r,o,s){var a,c=256,l=s.pow(c,6),u=s.pow(2,52),h=2*u,d=c-1;function f(t,e,n){var i=[],d=y(g((e=1==e?{entropy:!0}:e||{}).entropy?[t,_(o)]:null==t?function(){try{var t;return a&&(t=a.randomBytes)?t=t(c):(t=new Uint8Array(c),(r.crypto||r.msCrypto).getRandomValues(t)),_(t)}catch(t){var e=r.navigator,n=e&&e.plugins;return[+new Date,r,n,r.screen,_(o)]}}():t,3),i),f=new p(i),w=function(){for(var t=f.g(6),e=l,n=0;t<u;)t=(t+n)*c,e*=c,n=f.g(1);for(;t>=h;)t/=2,e/=2,n>>>=1;return(t+n)/e};return w.int32=function(){return 0|f.g(4)},w.quick=function(){return f.g(4)/4294967296},w.double=w,y(_(f.S),o),(e.pass||n||function(t,e,n,i){return i&&(i.S&&m(i,f),t.state=function(){return m(f,{})}),n?(s.random=t,e):t})(w,d,"global"in e?e.global:this==s,e.state)}function p(t){var e,n=t.length,i=this,r=0,o=i.i=i.j=0,s=i.S=[];for(n||(t=[n++]);r<c;)s[r]=r++;for(r=0;r<c;r++)s[r]=s[o=d&o+t[r%n]+(e=s[r])],s[o]=e;(i.g=function(t){for(var e,n=0,r=i.i,o=i.j,s=i.S;t--;)e=s[r=d&r+1],n=n*c+s[d&(s[r]=s[o=d&o+e])+(s[o]=e)];return i.i=r,i.j=o,n})(c)}function m(t,e){return e.i=t.i,e.j=t.j,e.S=t.S.slice(),e}function g(t,e){var n,i=[],r=typeof t;if(e&&"object"==r)for(n in t)try{i.push(g(t[n],e-1))}catch(t){}return i.length?i:"string"==r?t:t+"\0"}function y(t,e){for(var n,i=t+"",r=0;r<i.length;)e[d&r]=d&(n^=19*e[d&r])+i.charCodeAt(r++);return _(e)}function _(t){return String.fromCharCode.apply(0,t)}if(y(s.random(),o),t.exports){t.exports=f;try{a=n(42)}catch(t){}}else void 0===(i=function(){return f}.call(e,n,e,t))||(t.exports=i)}("undefined"!=typeof self?self:this,[],Math)},42:()=>{}},e={};function n(i){var r=e[i];if(void 0!==r)return r.exports;var o=e[i]={id:i,loaded:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}n.amdD=function(){throw new Error("define cannot be used indirect")},n.amdO={},n.d=(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.nmd=t=>(t.paths=[],t.children||(t.children=[]),t),(()=>{"use strict";var t={};function e(t){return null==t}n.r(t),n.d(t,{exclude:()=>re,extract:()=>Zt,parse:()=>Qt,parseUrl:()=>ee,pick:()=>ie,stringify:()=>te,stringifyUrl:()=>ne});var i={isNothing:e,isObject:function(t){return"object"==typeof t&&null!==t},toArray:function(t){return Array.isArray(t)?t:e(t)?[]:[t]},repeat:function(t,e){var n,i="";for(n=0;n<e;n+=1)i+=t;return i},isNegativeZero:function(t){return 0===t&&Number.NEGATIVE_INFINITY===1/t},extend:function(t,e){var n,i,r,o;if(e)for(n=0,i=(o=Object.keys(e)).length;n<i;n+=1)t[r=o[n]]=e[r];return t}};function r(t,e){var n="",i=t.reason||"(unknown reason)";return t.mark?(t.mark.name&&(n+='in "'+t.mark.name+'" '),n+="("+(t.mark.line+1)+":"+(t.mark.column+1)+")",!e&&t.mark.snippet&&(n+="\n\n"+t.mark.snippet),i+" "+n):i}function o(t,e){Error.call(this),this.name="YAMLException",this.reason=t,this.mark=e,this.message=r(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack||""}o.prototype=Object.create(Error.prototype),o.prototype.constructor=o,o.prototype.toString=function(t){return this.name+": "+r(this,t)};var s=o;function a(t,e,n,i,r){var o="",s="",a=Math.floor(r/2)-1;return i-e>a&&(e=i-a+(o=" ... ").length),n-i>a&&(n=i+a-(s=" ...").length),{str:o+t.slice(e,n).replace(/\t/g,"→")+s,pos:i-e+o.length}}function c(t,e){return i.repeat(" ",e-t.length)+t}var l=function(t,e){if(e=Object.create(e||null),!t.buffer)return null;e.maxLength||(e.maxLength=79),"number"!=typeof e.indent&&(e.indent=1),"number"!=typeof e.linesBefore&&(e.linesBefore=3),"number"!=typeof e.linesAfter&&(e.linesAfter=2);for(var n,r=/\r?\n|\r|\0/g,o=[0],s=[],l=-1;n=r.exec(t.buffer);)s.push(n.index),o.push(n.index+n[0].length),t.position<=n.index&&l<0&&(l=o.length-2);l<0&&(l=o.length-1);var u,h,d="",f=Math.min(t.line+e.linesAfter,s.length).toString().length,p=e.maxLength-(e.indent+f+3);for(u=1;u<=e.linesBefore&&!(l-u<0);u++)h=a(t.buffer,o[l-u],s[l-u],t.position-(o[l]-o[l-u]),p),d=i.repeat(" ",e.indent)+c((t.line-u+1).toString(),f)+" | "+h.str+"\n"+d;for(h=a(t.buffer,o[l],s[l],t.position,p),d+=i.repeat(" ",e.indent)+c((t.line+1).toString(),f)+" | "+h.str+"\n",d+=i.repeat("-",e.indent+f+3+h.pos)+"^\n",u=1;u<=e.linesAfter&&!(l+u>=s.length);u++)h=a(t.buffer,o[l+u],s[l+u],t.position-(o[l]-o[l+u]),p),d+=i.repeat(" ",e.indent)+c((t.line+u+1).toString(),f)+" | "+h.str+"\n";return d.replace(/\n$/,"")},u=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],h=["scalar","sequence","mapping"];var d=function(t,e){if(e=e||{},Object.keys(e).forEach((function(e){if(-1===u.indexOf(e))throw new s('Unknown option "'+e+'" is met in definition of "'+t+'" YAML type.')})),this.options=e,this.tag=t,this.kind=e.kind||null,this.resolve=e.resolve||function(){return!0},this.construct=e.construct||function(t){return t},this.instanceOf=e.instanceOf||null,this.predicate=e.predicate||null,this.represent=e.represent||null,this.representName=e.representName||null,this.defaultStyle=e.defaultStyle||null,this.multi=e.multi||!1,this.styleAliases=function(t){var e={};return null!==t&&Object.keys(t).forEach((function(n){t[n].forEach((function(t){e[String(t)]=n}))})),e}(e.styleAliases||null),-1===h.indexOf(this.kind))throw new s('Unknown kind "'+this.kind+'" is specified for "'+t+'" YAML type.')};function f(t,e){var n=[];return t[e].forEach((function(t){var e=n.length;n.forEach((function(n,i){n.tag===t.tag&&n.kind===t.kind&&n.multi===t.multi&&(e=i)})),n[e]=t})),n}function p(t){return this.extend(t)}p.prototype.extend=function(t){var e=[],n=[];if(t instanceof d)n.push(t);else if(Array.isArray(t))n=n.concat(t);else{if(!t||!Array.isArray(t.implicit)&&!Array.isArray(t.explicit))throw new s("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");t.implicit&&(e=e.concat(t.implicit)),t.explicit&&(n=n.concat(t.explicit))}e.forEach((function(t){if(!(t instanceof d))throw new s("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(t.loadKind&&"scalar"!==t.loadKind)throw new s("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(t.multi)throw new s("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")})),n.forEach((function(t){if(!(t instanceof d))throw new s("Specified list of YAML types (or a single Type object) contains a non-Type object.")}));var i=Object.create(p.prototype);return i.implicit=(this.implicit||[]).concat(e),i.explicit=(this.explicit||[]).concat(n),i.compiledImplicit=f(i,"implicit"),i.compiledExplicit=f(i,"explicit"),i.compiledTypeMap=function(){var t,e,n={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function i(t){t.multi?(n.multi[t.kind].push(t),n.multi.fallback.push(t)):n[t.kind][t.tag]=n.fallback[t.tag]=t}for(t=0,e=arguments.length;t<e;t+=1)arguments[t].forEach(i);return n}(i.compiledImplicit,i.compiledExplicit),i};var m=p,g=new d("tag:yaml.org,2002:str",{kind:"scalar",construct:function(t){return null!==t?t:""}}),y=new d("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(t){return null!==t?t:[]}}),_=new d("tag:yaml.org,2002:map",{kind:"mapping",construct:function(t){return null!==t?t:{}}}),w=new m({explicit:[g,y,_]});var b=new d("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(t){if(null===t)return!0;var e=t.length;return 1===e&&"~"===t||4===e&&("null"===t||"Null"===t||"NULL"===t)},construct:function(){return null},predicate:function(t){return null===t},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});var v=new d("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(t){if(null===t)return!1;var e=t.length;return 4===e&&("true"===t||"True"===t||"TRUE"===t)||5===e&&("false"===t||"False"===t||"FALSE"===t)},construct:function(t){return"true"===t||"True"===t||"TRUE"===t},predicate:function(t){return"[object Boolean]"===Object.prototype.toString.call(t)},represent:{lowercase:function(t){return t?"true":"false"},uppercase:function(t){return t?"TRUE":"FALSE"},camelcase:function(t){return t?"True":"False"}},defaultStyle:"lowercase"});function x(t){return 48<=t&&t<=55}function E(t){return 48<=t&&t<=57}var A=new d("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(t){if(null===t)return!1;var e,n,i=t.length,r=0,o=!1;if(!i)return!1;if("-"!==(e=t[r])&&"+"!==e||(e=t[++r]),"0"===e){if(r+1===i)return!0;if("b"===(e=t[++r])){for(r++;r<i;r++)if("_"!==(e=t[r])){if("0"!==e&&"1"!==e)return!1;o=!0}return o&&"_"!==e}if("x"===e){for(r++;r<i;r++)if("_"!==(e=t[r])){if(!(48<=(n=t.charCodeAt(r))&&n<=57||65<=n&&n<=70||97<=n&&n<=102))return!1;o=!0}return o&&"_"!==e}if("o"===e){for(r++;r<i;r++)if("_"!==(e=t[r])){if(!x(t.charCodeAt(r)))return!1;o=!0}return o&&"_"!==e}}if("_"===e)return!1;for(;r<i;r++)if("_"!==(e=t[r])){if(!E(t.charCodeAt(r)))return!1;o=!0}return!(!o||"_"===e)},construct:function(t){var e,n=t,i=1;if(-1!==n.indexOf("_")&&(n=n.replace(/_/g,"")),"-"!==(e=n[0])&&"+"!==e||("-"===e&&(i=-1),e=(n=n.slice(1))[0]),"0"===n)return 0;if("0"===e){if("b"===n[1])return i*parseInt(n.slice(2),2);if("x"===n[1])return i*parseInt(n.slice(2),16);if("o"===n[1])return i*parseInt(n.slice(2),8)}return i*parseInt(n,10)},predicate:function(t){return"[object Number]"===Object.prototype.toString.call(t)&&t%1==0&&!i.isNegativeZero(t)},represent:{binary:function(t){return t>=0?"0b"+t.toString(2):"-0b"+t.toString(2).slice(1)},octal:function(t){return t>=0?"0o"+t.toString(8):"-0o"+t.toString(8).slice(1)},decimal:function(t){return t.toString(10)},hexadecimal:function(t){return t>=0?"0x"+t.toString(16).toUpperCase():"-0x"+t.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),C=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");var S=/^[-+]?[0-9]+e/;var k=new d("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(t){return null!==t&&!(!C.test(t)||"_"===t[t.length-1])},construct:function(t){var e,n;return n="-"===(e=t.replace(/_/g,"").toLowerCase())[0]?-1:1,"+-".indexOf(e[0])>=0&&(e=e.slice(1)),".inf"===e?1===n?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:".nan"===e?NaN:n*parseFloat(e,10)},predicate:function(t){return"[object Number]"===Object.prototype.toString.call(t)&&(t%1!=0||i.isNegativeZero(t))},represent:function(t,e){var n;if(isNaN(t))switch(e){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===t)switch(e){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===t)switch(e){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(i.isNegativeZero(t))return"-0.0";return n=t.toString(10),S.test(n)?n.replace("e",".e"):n},defaultStyle:"lowercase"}),T=w.extend({implicit:[b,v,A,k]}),I=T,N=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),O=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");var M=new d("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(t){return null!==t&&(null!==N.exec(t)||null!==O.exec(t))},construct:function(t){var e,n,i,r,o,s,a,c,l=0,u=null;if(null===(e=N.exec(t))&&(e=O.exec(t)),null===e)throw new Error("Date resolve error");if(n=+e[1],i=+e[2]-1,r=+e[3],!e[4])return new Date(Date.UTC(n,i,r));if(o=+e[4],s=+e[5],a=+e[6],e[7]){for(l=e[7].slice(0,3);l.length<3;)l+="0";l=+l}return e[9]&&(u=6e4*(60*+e[10]+ +(e[11]||0)),"-"===e[9]&&(u=-u)),c=new Date(Date.UTC(n,i,r,o,s,a,l)),u&&c.setTime(c.getTime()-u),c},instanceOf:Date,represent:function(t){return t.toISOString()}});var j=new d("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(t){return"<<"===t||null===t}}),F="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\n\r";var D=new d("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(t){if(null===t)return!1;var e,n,i=0,r=t.length,o=F;for(n=0;n<r;n++)if(!((e=o.indexOf(t.charAt(n)))>64)){if(e<0)return!1;i+=6}return i%8==0},construct:function(t){var e,n,i=t.replace(/[\r\n=]/g,""),r=i.length,o=F,s=0,a=[];for(e=0;e<r;e++)e%4==0&&e&&(a.push(s>>16&255),a.push(s>>8&255),a.push(255&s)),s=s<<6|o.indexOf(i.charAt(e));return 0===(n=r%4*6)?(a.push(s>>16&255),a.push(s>>8&255),a.push(255&s)):18===n?(a.push(s>>10&255),a.push(s>>2&255)):12===n&&a.push(s>>4&255),new Uint8Array(a)},predicate:function(t){return"[object Uint8Array]"===Object.prototype.toString.call(t)},represent:function(t){var e,n,i="",r=0,o=t.length,s=F;for(e=0;e<o;e++)e%3==0&&e&&(i+=s[r>>18&63],i+=s[r>>12&63],i+=s[r>>6&63],i+=s[63&r]),r=(r<<8)+t[e];return 0===(n=o%3)?(i+=s[r>>18&63],i+=s[r>>12&63],i+=s[r>>6&63],i+=s[63&r]):2===n?(i+=s[r>>10&63],i+=s[r>>4&63],i+=s[r<<2&63],i+=s[64]):1===n&&(i+=s[r>>2&63],i+=s[r<<4&63],i+=s[64],i+=s[64]),i}}),L=Object.prototype.hasOwnProperty,z=Object.prototype.toString;var R=new d("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(t){if(null===t)return!0;var e,n,i,r,o,s=[],a=t;for(e=0,n=a.length;e<n;e+=1){if(i=a[e],o=!1,"[object Object]"!==z.call(i))return!1;for(r in i)if(L.call(i,r)){if(o)return!1;o=!0}if(!o)return!1;if(-1!==s.indexOf(r))return!1;s.push(r)}return!0},construct:function(t){return null!==t?t:[]}}),K=Object.prototype.toString;var $=new d("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(t){if(null===t)return!0;var e,n,i,r,o,s=t;for(o=new Array(s.length),e=0,n=s.length;e<n;e+=1){if(i=s[e],"[object Object]"!==K.call(i))return!1;if(1!==(r=Object.keys(i)).length)return!1;o[e]=[r[0],i[r[0]]]}return!0},construct:function(t){if(null===t)return[];var e,n,i,r,o,s=t;for(o=new Array(s.length),e=0,n=s.length;e<n;e+=1)i=s[e],r=Object.keys(i),o[e]=[r[0],i[r[0]]];return o}}),P=Object.prototype.hasOwnProperty;var V=new d("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(t){if(null===t)return!0;var e,n=t;for(e in n)if(P.call(n,e)&&null!==n[e])return!1;return!0},construct:function(t){return null!==t?t:{}}}),B=I.extend({implicit:[M,j],explicit:[D,R,$,V]}),U=Object.prototype.hasOwnProperty,q=1,J=2,G=3,W=4,H=1,Y=2,X=3,Z=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Q=/[\x85\u2028\u2029]/,tt=/[,\[\]\{\}]/,et=/^(?:!|!!|![a-z\-]+!)$/i,nt=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function it(t){return Object.prototype.toString.call(t)}function rt(t){return 10===t||13===t}function ot(t){return 9===t||32===t}function st(t){return 9===t||32===t||10===t||13===t}function at(t){return 44===t||91===t||93===t||123===t||125===t}function ct(t){var e;return 48<=t&&t<=57?t-48:97<=(e=32|t)&&e<=102?e-97+10:-1}function lt(t){return 48===t?"\0":97===t?"":98===t?"\b":116===t||9===t?"\t":110===t?"\n":118===t?"\v":102===t?"\f":114===t?"\r":101===t?"":32===t?" ":34===t?'"':47===t?"/":92===t?"\\":78===t?"":95===t?" ":76===t?"\u2028":80===t?"\u2029":""}function ut(t){return t<=65535?String.fromCharCode(t):String.fromCharCode(55296+(t-65536>>10),56320+(t-65536&1023))}for(var ht=new Array(256),dt=new Array(256),ft=0;ft<256;ft++)ht[ft]=lt(ft)?1:0,dt[ft]=lt(ft);function pt(t,e){this.input=t,this.filename=e.filename||null,this.schema=e.schema||B,this.onWarning=e.onWarning||null,this.legacy=e.legacy||!1,this.json=e.json||!1,this.listener=e.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=t.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function mt(t,e){var n={name:t.filename,buffer:t.input.slice(0,-1),position:t.position,line:t.line,column:t.position-t.lineStart};return n.snippet=l(n),new s(e,n)}function gt(t,e){throw mt(t,e)}function yt(t,e){t.onWarning&&t.onWarning.call(null,mt(t,e))}var _t={YAML:function(t,e,n){var i,r,o;null!==t.version&&gt(t,"duplication of %YAML directive"),1!==n.length&&gt(t,"YAML directive accepts exactly one argument"),null===(i=/^([0-9]+)\.([0-9]+)$/.exec(n[0]))&&gt(t,"ill-formed argument of the YAML directive"),r=parseInt(i[1],10),o=parseInt(i[2],10),1!==r&&gt(t,"unacceptable YAML version of the document"),t.version=n[0],t.checkLineBreaks=o<2,1!==o&&2!==o&&yt(t,"unsupported YAML version of the document")},TAG:function(t,e,n){var i,r;2!==n.length&&gt(t,"TAG directive accepts exactly two arguments"),i=n[0],r=n[1],et.test(i)||gt(t,"ill-formed tag handle (first argument) of the TAG directive"),U.call(t.tagMap,i)&&gt(t,'there is a previously declared suffix for "'+i+'" tag handle'),nt.test(r)||gt(t,"ill-formed tag prefix (second argument) of the TAG directive");try{r=decodeURIComponent(r)}catch(e){gt(t,"tag prefix is malformed: "+r)}t.tagMap[i]=r}};function wt(t,e,n,i){var r,o,s,a;if(e<n){if(a=t.input.slice(e,n),i)for(r=0,o=a.length;r<o;r+=1)9===(s=a.charCodeAt(r))||32<=s&&s<=1114111||gt(t,"expected valid JSON character");else Z.test(a)&&gt(t,"the stream contains non-printable characters");t.result+=a}}function bt(t,e,n,r){var o,s,a,c;for(i.isObject(n)||gt(t,"cannot merge mappings; the provided source object is unacceptable"),a=0,c=(o=Object.keys(n)).length;a<c;a+=1)s=o[a],U.call(e,s)||(e[s]=n[s],r[s]=!0)}function vt(t,e,n,i,r,o,s,a,c){var l,u;if(Array.isArray(r))for(l=0,u=(r=Array.prototype.slice.call(r)).length;l<u;l+=1)Array.isArray(r[l])&&gt(t,"nested arrays are not supported inside keys"),"object"==typeof r&&"[object Object]"===it(r[l])&&(r[l]="[object Object]");if("object"==typeof r&&"[object Object]"===it(r)&&(r="[object Object]"),r=String(r),null===e&&(e={}),"tag:yaml.org,2002:merge"===i)if(Array.isArray(o))for(l=0,u=o.length;l<u;l+=1)bt(t,e,o[l],n);else bt(t,e,o,n);else t.json||U.call(n,r)||!U.call(e,r)||(t.line=s||t.line,t.lineStart=a||t.lineStart,t.position=c||t.position,gt(t,"duplicated mapping key")),"__proto__"===r?Object.defineProperty(e,r,{configurable:!0,enumerable:!0,writable:!0,value:o}):e[r]=o,delete n[r];return e}function xt(t){var e;10===(e=t.input.charCodeAt(t.position))?t.position++:13===e?(t.position++,10===t.input.charCodeAt(t.position)&&t.position++):gt(t,"a line break is expected"),t.line+=1,t.lineStart=t.position,t.firstTabInLine=-1}function Et(t,e,n){for(var i=0,r=t.input.charCodeAt(t.position);0!==r;){for(;ot(r);)9===r&&-1===t.firstTabInLine&&(t.firstTabInLine=t.position),r=t.input.charCodeAt(++t.position);if(e&&35===r)do{r=t.input.charCodeAt(++t.position)}while(10!==r&&13!==r&&0!==r);if(!rt(r))break;for(xt(t),r=t.input.charCodeAt(t.position),i++,t.lineIndent=0;32===r;)t.lineIndent++,r=t.input.charCodeAt(++t.position)}return-1!==n&&0!==i&&t.lineIndent<n&&yt(t,"deficient indentation"),i}function At(t){var e,n=t.position;return!(45!==(e=t.input.charCodeAt(n))&&46!==e||e!==t.input.charCodeAt(n+1)||e!==t.input.charCodeAt(n+2)||(n+=3,0!==(e=t.input.charCodeAt(n))&&!st(e)))}function Ct(t,e){1===e?t.result+=" ":e>1&&(t.result+=i.repeat("\n",e-1))}function St(t,e){var n,i,r=t.tag,o=t.anchor,s=[],a=!1;if(-1!==t.firstTabInLine)return!1;for(null!==t.anchor&&(t.anchorMap[t.anchor]=s),i=t.input.charCodeAt(t.position);0!==i&&(-1!==t.firstTabInLine&&(t.position=t.firstTabInLine,gt(t,"tab characters must not be used in indentation")),45===i)&&st(t.input.charCodeAt(t.position+1));)if(a=!0,t.position++,Et(t,!0,-1)&&t.lineIndent<=e)s.push(null),i=t.input.charCodeAt(t.position);else if(n=t.line,It(t,e,G,!1,!0),s.push(t.result),Et(t,!0,-1),i=t.input.charCodeAt(t.position),(t.line===n||t.lineIndent>e)&&0!==i)gt(t,"bad indentation of a sequence entry");else if(t.lineIndent<e)break;return!!a&&(t.tag=r,t.anchor=o,t.kind="sequence",t.result=s,!0)}function kt(t){var e,n,i,r,o=!1,s=!1;if(33!==(r=t.input.charCodeAt(t.position)))return!1;if(null!==t.tag&&gt(t,"duplication of a tag property"),60===(r=t.input.charCodeAt(++t.position))?(o=!0,r=t.input.charCodeAt(++t.position)):33===r?(s=!0,n="!!",r=t.input.charCodeAt(++t.position)):n="!",e=t.position,o){do{r=t.input.charCodeAt(++t.position)}while(0!==r&&62!==r);t.position<t.length?(i=t.input.slice(e,t.position),r=t.input.charCodeAt(++t.position)):gt(t,"unexpected end of the stream within a verbatim tag")}else{for(;0!==r&&!st(r);)33===r&&(s?gt(t,"tag suffix cannot contain exclamation marks"):(n=t.input.slice(e-1,t.position+1),et.test(n)||gt(t,"named tag handle cannot contain such characters"),s=!0,e=t.position+1)),r=t.input.charCodeAt(++t.position);i=t.input.slice(e,t.position),tt.test(i)&&gt(t,"tag suffix cannot contain flow indicator characters")}i&&!nt.test(i)&&gt(t,"tag name cannot contain such characters: "+i);try{i=decodeURIComponent(i)}catch(e){gt(t,"tag name is malformed: "+i)}return o?t.tag=i:U.call(t.tagMap,n)?t.tag=t.tagMap[n]+i:"!"===n?t.tag="!"+i:"!!"===n?t.tag="tag:yaml.org,2002:"+i:gt(t,'undeclared tag handle "'+n+'"'),!0}function Tt(t){var e,n;if(38!==(n=t.input.charCodeAt(t.position)))return!1;for(null!==t.anchor&&gt(t,"duplication of an anchor property"),n=t.input.charCodeAt(++t.position),e=t.position;0!==n&&!st(n)&&!at(n);)n=t.input.charCodeAt(++t.position);return t.position===e&&gt(t,"name of an anchor node must contain at least one character"),t.anchor=t.input.slice(e,t.position),!0}function It(t,e,n,r,o){var s,a,c,l,u,h,d,f,p,m=1,g=!1,y=!1;if(null!==t.listener&&t.listener("open",t),t.tag=null,t.anchor=null,t.kind=null,t.result=null,s=a=c=W===n||G===n,r&&Et(t,!0,-1)&&(g=!0,t.lineIndent>e?m=1:t.lineIndent===e?m=0:t.lineIndent<e&&(m=-1)),1===m)for(;kt(t)||Tt(t);)Et(t,!0,-1)?(g=!0,c=s,t.lineIndent>e?m=1:t.lineIndent===e?m=0:t.lineIndent<e&&(m=-1)):c=!1;if(c&&(c=g||o),1!==m&&W!==n||(f=q===n||J===n?e:e+1,p=t.position-t.lineStart,1===m?c&&(St(t,p)||function(t,e,n){var i,r,o,s,a,c,l,u=t.tag,h=t.anchor,d={},f=Object.create(null),p=null,m=null,g=null,y=!1,_=!1;if(-1!==t.firstTabInLine)return!1;for(null!==t.anchor&&(t.anchorMap[t.anchor]=d),l=t.input.charCodeAt(t.position);0!==l;){if(y||-1===t.firstTabInLine||(t.position=t.firstTabInLine,gt(t,"tab characters must not be used in indentation")),i=t.input.charCodeAt(t.position+1),o=t.line,63!==l&&58!==l||!st(i)){if(s=t.line,a=t.lineStart,c=t.position,!It(t,n,J,!1,!0))break;if(t.line===o){for(l=t.input.charCodeAt(t.position);ot(l);)l=t.input.charCodeAt(++t.position);if(58===l)st(l=t.input.charCodeAt(++t.position))||gt(t,"a whitespace character is expected after the key-value separator within a block mapping"),y&&(vt(t,d,f,p,m,null,s,a,c),p=m=g=null),_=!0,y=!1,r=!1,p=t.tag,m=t.result;else{if(!_)return t.tag=u,t.anchor=h,!0;gt(t,"can not read an implicit mapping pair; a colon is missed")}}else{if(!_)return t.tag=u,t.anchor=h,!0;gt(t,"can not read a block mapping entry; a multiline key may not be an implicit key")}}else 63===l?(y&&(vt(t,d,f,p,m,null,s,a,c),p=m=g=null),_=!0,y=!0,r=!0):y?(y=!1,r=!0):gt(t,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),t.position+=1,l=i;if((t.line===o||t.lineIndent>e)&&(y&&(s=t.line,a=t.lineStart,c=t.position),It(t,e,W,!0,r)&&(y?m=t.result:g=t.result),y||(vt(t,d,f,p,m,g,s,a,c),p=m=g=null),Et(t,!0,-1),l=t.input.charCodeAt(t.position)),(t.line===o||t.lineIndent>e)&&0!==l)gt(t,"bad indentation of a mapping entry");else if(t.lineIndent<e)break}return y&&vt(t,d,f,p,m,null,s,a,c),_&&(t.tag=u,t.anchor=h,t.kind="mapping",t.result=d),_}(t,p,f))||function(t,e){var n,i,r,o,s,a,c,l,u,h,d,f,p=!0,m=t.tag,g=t.anchor,y=Object.create(null);if(91===(f=t.input.charCodeAt(t.position)))s=93,l=!1,o=[];else{if(123!==f)return!1;s=125,l=!0,o={}}for(null!==t.anchor&&(t.anchorMap[t.anchor]=o),f=t.input.charCodeAt(++t.position);0!==f;){if(Et(t,!0,e),(f=t.input.charCodeAt(t.position))===s)return t.position++,t.tag=m,t.anchor=g,t.kind=l?"mapping":"sequence",t.result=o,!0;p?44===f&&gt(t,"expected the node content, but found ','"):gt(t,"missed comma between flow collection entries"),d=null,a=c=!1,63===f&&st(t.input.charCodeAt(t.position+1))&&(a=c=!0,t.position++,Et(t,!0,e)),n=t.line,i=t.lineStart,r=t.position,It(t,e,q,!1,!0),h=t.tag,u=t.result,Et(t,!0,e),f=t.input.charCodeAt(t.position),!c&&t.line!==n||58!==f||(a=!0,f=t.input.charCodeAt(++t.position),Et(t,!0,e),It(t,e,q,!1,!0),d=t.result),l?vt(t,o,y,h,u,d,n,i,r):a?o.push(vt(t,null,y,h,u,d,n,i,r)):o.push(u),Et(t,!0,e),44===(f=t.input.charCodeAt(t.position))?(p=!0,f=t.input.charCodeAt(++t.position)):p=!1}gt(t,"unexpected end of the stream within a flow collection")}(t,f)?y=!0:(a&&function(t,e){var n,r,o,s,a,c=H,l=!1,u=!1,h=e,d=0,f=!1;if(124===(s=t.input.charCodeAt(t.position)))r=!1;else{if(62!==s)return!1;r=!0}for(t.kind="scalar",t.result="";0!==s;)if(43===(s=t.input.charCodeAt(++t.position))||45===s)H===c?c=43===s?X:Y:gt(t,"repeat of a chomping mode identifier");else{if(!((o=48<=(a=s)&&a<=57?a-48:-1)>=0))break;0===o?gt(t,"bad explicit indentation width of a block scalar; it cannot be less than one"):u?gt(t,"repeat of an indentation width identifier"):(h=e+o-1,u=!0)}if(ot(s)){do{s=t.input.charCodeAt(++t.position)}while(ot(s));if(35===s)do{s=t.input.charCodeAt(++t.position)}while(!rt(s)&&0!==s)}for(;0!==s;){for(xt(t),t.lineIndent=0,s=t.input.charCodeAt(t.position);(!u||t.lineIndent<h)&&32===s;)t.lineIndent++,s=t.input.charCodeAt(++t.position);if(!u&&t.lineIndent>h&&(h=t.lineIndent),rt(s))d++;else{if(t.lineIndent<h){c===X?t.result+=i.repeat("\n",l?1+d:d):c===H&&l&&(t.result+="\n");break}for(r?ot(s)?(f=!0,t.result+=i.repeat("\n",l?1+d:d)):f?(f=!1,t.result+=i.repeat("\n",d+1)):0===d?l&&(t.result+=" "):t.result+=i.repeat("\n",d):t.result+=i.repeat("\n",l?1+d:d),l=!0,u=!0,d=0,n=t.position;!rt(s)&&0!==s;)s=t.input.charCodeAt(++t.position);wt(t,n,t.position,!1)}}return!0}(t,f)||function(t,e){var n,i,r;if(39!==(n=t.input.charCodeAt(t.position)))return!1;for(t.kind="scalar",t.result="",t.position++,i=r=t.position;0!==(n=t.input.charCodeAt(t.position));)if(39===n){if(wt(t,i,t.position,!0),39!==(n=t.input.charCodeAt(++t.position)))return!0;i=t.position,t.position++,r=t.position}else rt(n)?(wt(t,i,r,!0),Ct(t,Et(t,!1,e)),i=r=t.position):t.position===t.lineStart&&At(t)?gt(t,"unexpected end of the document within a single quoted scalar"):(t.position++,r=t.position);gt(t,"unexpected end of the stream within a single quoted scalar")}(t,f)||function(t,e){var n,i,r,o,s,a,c;if(34!==(a=t.input.charCodeAt(t.position)))return!1;for(t.kind="scalar",t.result="",t.position++,n=i=t.position;0!==(a=t.input.charCodeAt(t.position));){if(34===a)return wt(t,n,t.position,!0),t.position++,!0;if(92===a){if(wt(t,n,t.position,!0),rt(a=t.input.charCodeAt(++t.position)))Et(t,!1,e);else if(a<256&&ht[a])t.result+=dt[a],t.position++;else if((s=120===(c=a)?2:117===c?4:85===c?8:0)>0){for(r=s,o=0;r>0;r--)(s=ct(a=t.input.charCodeAt(++t.position)))>=0?o=(o<<4)+s:gt(t,"expected hexadecimal character");t.result+=ut(o),t.position++}else gt(t,"unknown escape sequence");n=i=t.position}else rt(a)?(wt(t,n,i,!0),Ct(t,Et(t,!1,e)),n=i=t.position):t.position===t.lineStart&&At(t)?gt(t,"unexpected end of the document within a double quoted scalar"):(t.position++,i=t.position)}gt(t,"unexpected end of the stream within a double quoted scalar")}(t,f)?y=!0:!function(t){var e,n,i;if(42!==(i=t.input.charCodeAt(t.position)))return!1;for(i=t.input.charCodeAt(++t.position),e=t.position;0!==i&&!st(i)&&!at(i);)i=t.input.charCodeAt(++t.position);return t.position===e&&gt(t,"name of an alias node must contain at least one character"),n=t.input.slice(e,t.position),U.call(t.anchorMap,n)||gt(t,'unidentified alias "'+n+'"'),t.result=t.anchorMap[n],Et(t,!0,-1),!0}(t)?function(t,e,n){var i,r,o,s,a,c,l,u,h=t.kind,d=t.result;if(st(u=t.input.charCodeAt(t.position))||at(u)||35===u||38===u||42===u||33===u||124===u||62===u||39===u||34===u||37===u||64===u||96===u)return!1;if((63===u||45===u)&&(st(i=t.input.charCodeAt(t.position+1))||n&&at(i)))return!1;for(t.kind="scalar",t.result="",r=o=t.position,s=!1;0!==u;){if(58===u){if(st(i=t.input.charCodeAt(t.position+1))||n&&at(i))break}else if(35===u){if(st(t.input.charCodeAt(t.position-1)))break}else{if(t.position===t.lineStart&&At(t)||n&&at(u))break;if(rt(u)){if(a=t.line,c=t.lineStart,l=t.lineIndent,Et(t,!1,-1),t.lineIndent>=e){s=!0,u=t.input.charCodeAt(t.position);continue}t.position=o,t.line=a,t.lineStart=c,t.lineIndent=l;break}}s&&(wt(t,r,o,!1),Ct(t,t.line-a),r=o=t.position,s=!1),ot(u)||(o=t.position+1),u=t.input.charCodeAt(++t.position)}return wt(t,r,o,!1),!!t.result||(t.kind=h,t.result=d,!1)}(t,f,q===n)&&(y=!0,null===t.tag&&(t.tag="?")):(y=!0,null===t.tag&&null===t.anchor||gt(t,"alias node should not have any properties")),null!==t.anchor&&(t.anchorMap[t.anchor]=t.result)):0===m&&(y=c&&St(t,p))),null===t.tag)null!==t.anchor&&(t.anchorMap[t.anchor]=t.result);else if("?"===t.tag){for(null!==t.result&&"scalar"!==t.kind&&gt(t,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+t.kind+'"'),l=0,u=t.implicitTypes.length;l<u;l+=1)if((d=t.implicitTypes[l]).resolve(t.result)){t.result=d.construct(t.result),t.tag=d.tag,null!==t.anchor&&(t.anchorMap[t.anchor]=t.result);break}}else if("!"!==t.tag){if(U.call(t.typeMap[t.kind||"fallback"],t.tag))d=t.typeMap[t.kind||"fallback"][t.tag];else for(d=null,l=0,u=(h=t.typeMap.multi[t.kind||"fallback"]).length;l<u;l+=1)if(t.tag.slice(0,h[l].tag.length)===h[l].tag){d=h[l];break}d||gt(t,"unknown tag !<"+t.tag+">"),null!==t.result&&d.kind!==t.kind&&gt(t,"unacceptable node kind for !<"+t.tag+'> tag; it should be "'+d.kind+'", not "'+t.kind+'"'),d.resolve(t.result,t.tag)?(t.result=d.construct(t.result,t.tag),null!==t.anchor&&(t.anchorMap[t.anchor]=t.result)):gt(t,"cannot resolve a node with !<"+t.tag+"> explicit tag")}return null!==t.listener&&t.listener("close",t),null!==t.tag||null!==t.anchor||y}function Nt(t){var e,n,i,r,o=t.position,s=!1;for(t.version=null,t.checkLineBreaks=t.legacy,t.tagMap=Object.create(null),t.anchorMap=Object.create(null);0!==(r=t.input.charCodeAt(t.position))&&(Et(t,!0,-1),r=t.input.charCodeAt(t.position),!(t.lineIndent>0||37!==r));){for(s=!0,r=t.input.charCodeAt(++t.position),e=t.position;0!==r&&!st(r);)r=t.input.charCodeAt(++t.position);for(i=[],(n=t.input.slice(e,t.position)).length<1&&gt(t,"directive name must not be less than one character in length");0!==r;){for(;ot(r);)r=t.input.charCodeAt(++t.position);if(35===r){do{r=t.input.charCodeAt(++t.position)}while(0!==r&&!rt(r));break}if(rt(r))break;for(e=t.position;0!==r&&!st(r);)r=t.input.charCodeAt(++t.position);i.push(t.input.slice(e,t.position))}0!==r&&xt(t),U.call(_t,n)?_t[n](t,n,i):yt(t,'unknown document directive "'+n+'"')}Et(t,!0,-1),0===t.lineIndent&&45===t.input.charCodeAt(t.position)&&45===t.input.charCodeAt(t.position+1)&&45===t.input.charCodeAt(t.position+2)?(t.position+=3,Et(t,!0,-1)):s&&gt(t,"directives end mark is expected"),It(t,t.lineIndent-1,W,!1,!0),Et(t,!0,-1),t.checkLineBreaks&&Q.test(t.input.slice(o,t.position))&&yt(t,"non-ASCII line breaks are interpreted as content"),t.documents.push(t.result),t.position===t.lineStart&&At(t)?46===t.input.charCodeAt(t.position)&&(t.position+=3,Et(t,!0,-1)):t.position<t.length-1&&gt(t,"end of the stream or a document separator is expected")}function Ot(t,e){e=e||{},0!==(t=String(t)).length&&(10!==t.charCodeAt(t.length-1)&&13!==t.charCodeAt(t.length-1)&&(t+="\n"),65279===t.charCodeAt(0)&&(t=t.slice(1)));var n=new pt(t,e),i=t.indexOf("\0");for(-1!==i&&(n.position=i,gt(n,"null byte is not allowed in input")),n.input+="\0";32===n.input.charCodeAt(n.position);)n.lineIndent+=1,n.position+=1;for(;n.position<n.length-1;)Nt(n);return n.documents}var Mt={loadAll:function(t,e,n){null!==e&&"object"==typeof e&&void 0===n&&(n=e,e=null);var i=Ot(t,n);if("function"!=typeof e)return i;for(var r=0,o=i.length;r<o;r+=1)e(i[r])},load:function(t,e){var n=Ot(t,e);if(0!==n.length){if(1===n.length)return n[0];throw new s("expected a single document in the stream, but found more")}}};Object.prototype.toString,Object.prototype.hasOwnProperty;function jt(t,e){return function(){throw new Error("Function yaml."+t+" is removed in js-yaml 4. Use yaml."+e+" instead, which is now safe by default.")}}var Ft=Mt.load;jt("safeLoad","load"),jt("safeLoadAll","loadAll"),jt("safeDump","dump");const Dt="%[a-f0-9]{2}",Lt=new RegExp("("+Dt+")|([^%]+?)","gi"),zt=new RegExp("("+Dt+")+","gi");function Rt(t,e){try{return[decodeURIComponent(t.join(""))]}catch{}if(1===t.length)return t;e=e||1;const n=t.slice(0,e),i=t.slice(e);return Array.prototype.concat.call([],Rt(n),Rt(i))}function Kt(t){try{return decodeURIComponent(t)}catch{let e=t.match(Lt)||[];for(let n=1;n<e.length;n++)e=(t=Rt(e,n).join("")).match(Lt)||[];return t}}function $t(t){if("string"!=typeof t)throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+typeof t+"`");try{return decodeURIComponent(t)}catch{return function(t){const e={"%FE%FF":"��","%FF%FE":"��"};let n=zt.exec(t);for(;n;){try{e[n[0]]=decodeURIComponent(n[0])}catch{const t=Kt(n[0]);t!==n[0]&&(e[n[0]]=t)}n=zt.exec(t)}e["%C2"]="�";const i=Object.keys(e);for(const n of i)t=t.replace(new RegExp(n,"g"),e[n]);return t}(t)}}function Pt(t,e){if("string"!=typeof t||"string"!=typeof e)throw new TypeError("Expected the arguments to be of type `string`");if(""===t||""===e)return[];const n=t.indexOf(e);return-1===n?[]:[t.slice(0,n),t.slice(n+e.length)]}function Vt(t,e){const n={};if(Array.isArray(e))for(const i of e){const e=Object.getOwnPropertyDescriptor(t,i);e?.enumerable&&Object.defineProperty(n,i,e)}else for(const i of Reflect.ownKeys(t)){const r=Object.getOwnPropertyDescriptor(t,i);if(r.enumerable){e(i,t[i],t)&&Object.defineProperty(n,i,r)}}return n}const Bt=t=>null==t,Ut=t=>encodeURIComponent(t).replace(/[!'()*]/g,(t=>`%${t.charCodeAt(0).toString(16).toUpperCase()}`)),qt=Symbol("encodeFragmentIdentifier");function Jt(t){if("string"!=typeof t||1!==t.length)throw new TypeError("arrayFormatSeparator must be single character string")}function Gt(t,e){return e.encode?e.strict?Ut(t):encodeURIComponent(t):t}function Wt(t,e){return e.decode?$t(t):t}function Ht(t){return Array.isArray(t)?t.sort():"object"==typeof t?Ht(Object.keys(t)).sort(((t,e)=>Number(t)-Number(e))).map((e=>t[e])):t}function Yt(t){const e=t.indexOf("#");return-1!==e&&(t=t.slice(0,e)),t}function Xt(t,e){return e.parseNumbers&&!Number.isNaN(Number(t))&&"string"==typeof t&&""!==t.trim()?t=Number(t):!e.parseBooleans||null===t||"true"!==t.toLowerCase()&&"false"!==t.toLowerCase()||(t="true"===t.toLowerCase()),t}function Zt(t){const e=(t=Yt(t)).indexOf("?");return-1===e?"":t.slice(e+1)}function Qt(t,e){Jt((e={decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1,...e}).arrayFormatSeparator);const n=function(t){let e;switch(t.arrayFormat){case"index":return(t,n,i)=>{e=/\[(\d*)]$/.exec(t),t=t.replace(/\[\d*]$/,""),e?(void 0===i[t]&&(i[t]={}),i[t][e[1]]=n):i[t]=n};case"bracket":return(t,n,i)=>{e=/(\[])$/.exec(t),t=t.replace(/\[]$/,""),e?void 0!==i[t]?i[t]=[...i[t],n]:i[t]=[n]:i[t]=n};case"colon-list-separator":return(t,n,i)=>{e=/(:list)$/.exec(t),t=t.replace(/:list$/,""),e?void 0!==i[t]?i[t]=[...i[t],n]:i[t]=[n]:i[t]=n};case"comma":case"separator":return(e,n,i)=>{const r="string"==typeof n&&n.includes(t.arrayFormatSeparator),o="string"==typeof n&&!r&&Wt(n,t).includes(t.arrayFormatSeparator);n=o?Wt(n,t):n;const s=r||o?n.split(t.arrayFormatSeparator).map((e=>Wt(e,t))):null===n?n:Wt(n,t);i[e]=s};case"bracket-separator":return(e,n,i)=>{const r=/(\[])$/.test(e);if(e=e.replace(/\[]$/,""),!r)return void(i[e]=n?Wt(n,t):n);const o=null===n?[]:n.split(t.arrayFormatSeparator).map((e=>Wt(e,t)));void 0!==i[e]?i[e]=[...i[e],...o]:i[e]=o};default:return(t,e,n)=>{void 0!==n[t]?n[t]=[...[n[t]].flat(),e]:n[t]=e}}}(e),i=Object.create(null);if("string"!=typeof t)return i;if(!(t=t.trim().replace(/^[?#&]/,"")))return i;for(const r of t.split("&")){if(""===r)continue;const t=e.decode?r.replace(/\+/g," "):r;let[o,s]=Pt(t,"=");void 0===o&&(o=t),s=void 0===s?null:["comma","separator","bracket-separator"].includes(e.arrayFormat)?s:Wt(s,e),n(Wt(o,e),s,i)}for(const[t,n]of Object.entries(i))if("object"==typeof n&&null!==n)for(const[t,i]of Object.entries(n))n[t]=Xt(i,e);else i[t]=Xt(n,e);return!1===e.sort?i:(!0===e.sort?Object.keys(i).sort():Object.keys(i).sort(e.sort)).reduce(((t,e)=>{const n=i[e];return Boolean(n)&&"object"==typeof n&&!Array.isArray(n)?t[e]=Ht(n):t[e]=n,t}),Object.create(null))}function te(t,e){if(!t)return"";Jt((e={encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:",",...e}).arrayFormatSeparator);const n=n=>e.skipNull&&Bt(t[n])||e.skipEmptyString&&""===t[n],i=function(t){switch(t.arrayFormat){case"index":return e=>(n,i)=>{const r=n.length;return void 0===i||t.skipNull&&null===i||t.skipEmptyString&&""===i?n:null===i?[...n,[Gt(e,t),"[",r,"]"].join("")]:[...n,[Gt(e,t),"[",Gt(r,t),"]=",Gt(i,t)].join("")]};case"bracket":return e=>(n,i)=>void 0===i||t.skipNull&&null===i||t.skipEmptyString&&""===i?n:null===i?[...n,[Gt(e,t),"[]"].join("")]:[...n,[Gt(e,t),"[]=",Gt(i,t)].join("")];case"colon-list-separator":return e=>(n,i)=>void 0===i||t.skipNull&&null===i||t.skipEmptyString&&""===i?n:null===i?[...n,[Gt(e,t),":list="].join("")]:[...n,[Gt(e,t),":list=",Gt(i,t)].join("")];case"comma":case"separator":case"bracket-separator":{const e="bracket-separator"===t.arrayFormat?"[]=":"=";return n=>(i,r)=>void 0===r||t.skipNull&&null===r||t.skipEmptyString&&""===r?i:(r=null===r?"":r,0===i.length?[[Gt(n,t),e,Gt(r,t)].join("")]:[[i,Gt(r,t)].join(t.arrayFormatSeparator)])}default:return e=>(n,i)=>void 0===i||t.skipNull&&null===i||t.skipEmptyString&&""===i?n:null===i?[...n,Gt(e,t)]:[...n,[Gt(e,t),"=",Gt(i,t)].join("")]}}(e),r={};for(const[e,i]of Object.entries(t))n(e)||(r[e]=i);const o=Object.keys(r);return!1!==e.sort&&o.sort(e.sort),o.map((n=>{const r=t[n];return void 0===r?"":null===r?Gt(n,e):Array.isArray(r)?0===r.length&&"bracket-separator"===e.arrayFormat?Gt(n,e)+"[]":r.reduce(i(n),[]).join("&"):Gt(n,e)+"="+Gt(r,e)})).filter((t=>t.length>0)).join("&")}function ee(t,e){e={decode:!0,...e};let[n,i]=Pt(t,"#");return void 0===n&&(n=t),{url:n?.split("?")?.[0]??"",query:Qt(Zt(t),e),...e&&e.parseFragmentIdentifier&&i?{fragmentIdentifier:Wt(i,e)}:{}}}function ne(t,e){e={encode:!0,strict:!0,[qt]:!0,...e};const n=Yt(t.url).split("?")[0]||"";let i=te({...Qt(Zt(t.url),{sort:!1}),...t.query},e);i&&(i=`?${i}`);let r=function(t){let e="";const n=t.indexOf("#");return-1!==n&&(e=t.slice(n)),e}(t.url);if(t.fragmentIdentifier){const i=new URL(n);i.hash=t.fragmentIdentifier,r=e[qt]?i.hash:`#${t.fragmentIdentifier}`}return`${n}${i}${r}`}function ie(t,e,n){n={parseFragmentIdentifier:!0,[qt]:!1,...n};const{url:i,query:r,fragmentIdentifier:o}=ee(t,n);return ne({url:i,query:Vt(r,e),fragmentIdentifier:o},n)}function re(t,e,n){return ie(t,Array.isArray(e)?t=>!e.includes(t):(t,n)=>!e(t,n),n)}const oe=t;class se{constructor(t,e){this._container=t,this._textEngine=e}setHidden(t){this._container.style.display=t?"none":"block"}removeAllChildrenOf(t){for(;t.firstChild;)t.removeChild(t.firstChild)}createAndAddChild(t,e,n){const i=document.createElement(t);return e&&(i.id=e),n&&(i.className=n),this._container.appendChild(i),i}}class ae extends se{constructor(t,e){super(t,e),this._pending=[],this._shown=!1,this._contentBox=this.createAndAddChild("div","","modal_content"),this._titleContainer=document.createElement("h3"),this._messageContainer=document.createElement("div"),this._messageContainer.className="modal_message",this._confirmBtn=document.createElement("a"),this._confirmBtn.className="btn_confirm btn",this._confirmBtn.href="javascript:void(0)",this._contentBox.appendChild(this._titleContainer),this._contentBox.appendChild(this._messageContainer),this._contentBox.appendChild(this._confirmBtn),this._confirmBtn.onclick=()=>{if(this._pending.length>0){const t=this._pending.shift();this._setContent(t.title,t.message,t.confirm,t.icon)}else this.setHidden(!0),this._clearContent()}}display(t,e,n,i){this._shown?this._pending.push({title:this._textEngine.localizeAndRender(t),message:this._textEngine.localizeAndRender(e),confirm:this._textEngine.localizeAndRender(n),icon:i}):(this._setContent(this._textEngine.localizeAndRender(t),this._textEngine.localizeAndRender(e),this._textEngine.localizeAndRender(n),i),this.setHidden(!1))}_setContent(t,e,n,i){this._titleContainer.textContent=t;const r=document.createElement("p");if(r.innerHTML=e,this._messageContainer.appendChild(r),i){const t=document.createElement("img");t.src=i,this._messageContainer.appendChild(t)}this._confirmBtn.textContent=n}_clearContent(){this._titleContainer.textContent="",this._messageContainer.innerHTML="",this._confirmBtn.textContent=""}}var ce=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};const le=new RegExp(`^[${["\\p{Script=Han}","\\p{Script=Bopomofo}","\\p{Script=Katakana}","\\p{Script=Hiragana}","\\p{Script=Hangul}"].join("")}]$`,"u");class ue extends se{constructor(t,e,n){if(super(t,e),this._messageContainer=this.createAndAddChild("div","","message_container"),this._choicesContainer=this.createAndAddChild("div","","choices_container"),null==n||null==n.typewriterSpeed)this._typewriterSpeed=30;else{if("number"!=typeof n.typewriterSpeed||isNaN(n.typewriterSpeed))throw new Error("Typewrite speed must be a valid number.");this._typewriterSpeed=n.typewriterSpeed}this._typewriterSpeed>0?this._typewriterFrameTime=1e3/this._typewriterSpeed:this._typewriterFrameTime=0}displayMessage(t,e,n){return ce(this,void 0,void 0,(function*(){return this._typewriterSpeed>0?yield this.typewriteMessage(t,n):this.updateMessage(t,n),new Promise((t=>{const n=document.createElement("a");n.className="btn",n.href="javascript: void(0)",n.innerHTML=this._textEngine.localizeAndRender(e),this._choicesContainer.appendChild(n),n.onclick=()=>{this._messageContainer.textContent="",n.onclick=null,n.remove(),t()}}))}))}displayChoices(t,e,n){return ce(this,void 0,void 0,(function*(){return this._typewriterSpeed>0?yield this.typewriteMessage(t,n):this.updateMessage(t,n),new Promise((t=>{let n=[];for(let i=0;i<e.length;i++){let r=document.createElement("a"),[o,s]=e[i];r.className="btn",r.innerHTML=this._textEngine.localizeAndRender(o),r.href="javascript: void(0);",r.setAttribute("data-choice-number",s.toString()),r.onclick=()=>{for(r of(this._messageContainer.textContent="",n))r.remove();t(s)},n.push(r),this._choicesContainer.appendChild(r)}}))}))}updateMessage(t,e){let n=`<p>${this._textEngine.localizeAndRender(t)}</p>`;e&&(n+=`<p><img src="${e}" /></p>`),this._messageContainer.innerHTML=n}typewriteMessage(t,e){return new Promise((n=>{this.removeAllChildrenOf(this._messageContainer);let i=document.createElement("p");this._messageContainer.appendChild(i);let r=function(t){const e=[];let n=0,i=0;for(;n<t.length;){const r=t[n];if(" "===r){for(++n;n<t.length&&" "===t[n];);e.push(t.substring(i,n)),i=n}else le.test(r)?(++n,e.push(t.substring(i,n)),i=n):++n}return i<n&&e.push(t.substring(i,n)),e}(this._textEngine.localize(t)),o="",s=0,a=null,c=t=>{a||(a=t);const l=t-a,u=Math.min(l/this._typewriterFrameTime,r.length);for(;s<u;)o+=r[s],++s;if(i.innerHTML=this._textEngine.render(o),s===r.length){if(e){let t=document.createElement("p"),n=document.createElement("img");n.src=e,t.appendChild(n),this._messageContainer.appendChild(t)}n()}else requestAnimationFrame(c)};requestAnimationFrame(c)}))}}class he extends se{constructor(t,e,n,i,r){if(super(t,e),this._collection=n,this._registry=i,this._titleContainer=this.createAndAddChild("h3"),r){if("string"!=typeof r.title)throw new Error("Title must be a string.");this._titleContainer.innerHTML=e.localizeAndRender(r.title),e.getLocalizationDictionary().addRequiredKey(r.title)}this._listContainer=this.createAndAddChild("ul"),this._collection.onChanged=(t,e)=>{this.renderList(t,e)},this._listContainer.onclick=t=>{let e=t.target;e instanceof HTMLLIElement&&this.onItemClicked&&this.onItemClicked(this.retrieveEffectProviderFromElement(e))}}}class de extends he{constructor(t,e,n,i,r){if(super(t,e,n,i,r),this._raritySpecificStyles=[],null!=r&&null!=r.raritySpecificStyles){if(!Array.isArray(r.raritySpecificStyles))throw new Error("raritySpecificStyles must be an array.");for(let t of r.raritySpecificStyles){const e=null==t.minRarity?-1/0:t.minRarity,n=null==t.maxRarity?1/0:t.maxRarity;if(!Array.isArray(t.styleClasses))throw new Error("styleClasses must be an array.");for(const e of t.styleClasses)if("string"!=typeof e)throw new Error("styleClasses must be an array of strings.");this._raritySpecificStyles.push({minRarity:e,maxRarity:n,styleClasses:[...t.styleClasses]})}}}renderList(t,e){if(this.removeAllChildrenOf(this._listContainer),!e.clear)for(const e in t.items){let n=document.createElement("li"),[i,r]=t.items[e];n.setAttribute("data-item-id",i.id);for(const t of this._raritySpecificStyles)i.rarity>=t.minRarity&&i.rarity<=t.maxRarity&&n.classList.add(...t.styleClasses);const o=this._textEngine.localizeAndRender(i.unlocalizedName);n.innerHTML=`${o} x${r}`,this._listContainer.appendChild(n)}}retrieveEffectProviderFromElement(t){return this._registry.get(t.getAttribute("data-item-id")||"")}}class fe extends he{constructor(t,e,n,i,r){super(t,e,n,i,r)}renderList(t,e){if(this.removeAllChildrenOf(this._listContainer),!e.clear)for(const e in t.items){let n=document.createElement("li"),i=t.items[e];n.innerHTML=this._textEngine.localizeAndRender(i[0].unlocalizedName),n.setAttribute("data-status-id",e),this._listContainer.appendChild(n)}}retrieveEffectProviderFromElement(t){return this._registry.get(t.getAttribute("data-status-id")||"")}}class pe{constructor(t){this.x=0,this.y=0,this.vx=0,this.vy=0,this.ax=0,this.ay=0,this.active=!0,this._el=document.createElement("div"),this._el.className=t}get element(){return this._el}addToScene(t){t.appendChild(this._el)}removeFromScene(t){t.removeChild(this._el)}updatePosition(t){this.active&&(this.vx+=this.ax*t,this.vy+=this.ay*t,this.x+=(this.vx+.5*this.ax*t)*t,this.y+=(this.vy+.5*this.ay*t)*t,this._el.style.top=this.y+"px",this._el.style.left=this.x+"px")}}class me extends se{confetti(){const t=["#f00","#0f0","#00f","#ff0","#0ff","#f0f","#000","#fff"];let e=[],n=this._container.offsetWidth,i=document.body.offsetHeight,r=Math.max(30,Math.ceil(n/20)),o=null;for(let i=0;i<r;i++){let i=new pe("particle_confetti");i.x=Math.random()*n,i.y=-10-300*Math.random(),i.vy=2*Math.random(),i.ay=8/60,i.element.style.backgroundColor=t[Math.floor(Math.random()*t.length)],i.element.style.width=Math.floor(6*Math.random()+4)+"px",i.element.style.height=i.element.style.width,i.addToScene(this._container),e.push(i)}const s=t=>{o||(o=t);let n=(t-o)/(1e3/60);o=t;for(let t of e)t.updatePosition(n),t.active&&t.y>1.5*i&&(t.active=!1,t.removeFromScene(this._container),r--);r>0&&requestAnimationFrame(s)};requestAnimationFrame(s)}}class ge extends se{constructor(t,e,n,i){if(super(t,e),this.removeAllChildrenOf(t),!i)return;const r=e.getLocalizationDictionary();if(i.preamble){let t=document.createElement("span");t.innerHTML=e.localizeAndRender(i.preamble),r.addRequiredKey(i.preamble),this._container.appendChild(t)}for(let t=0;t<i.buttons.length;t++){const o=i.buttons[t];if(t>0){let t=document.createElement("span");t.textContent=" | ",this._container.appendChild(t)}let s=document.createElement("a");if(s.innerHTML=e.localizeAndRender(o.text),r.addRequiredKey(o.text),"styleClasses"in o){if(!Array.isArray(o.styleClasses))throw new Error("Style classes should be an array.");for(let t of o.styleClasses)s.classList.add(t)}"url"in o?s.href=o.url:(r.addRequiredKey(o.messageTitle),r.addRequiredKey(o.message),r.addRequiredKey(o.confirmText),s.onclick=t=>{t.preventDefault(),n.display(o.messageTitle,o.message,o.confirmText,o.icon)}),this._container.appendChild(s)}}}class ye{constructor(t,e,n){if(this._conditionalStyles=[],this._container=t,this._text=n.text,n.conditionalStyles)for(const t of n.conditionalStyles)this._conditionalStyles.push({conditionExpression:e.compile(t.condition),classNames:t.styleClasses?[...t.styleClasses]:[]})}update(t,e){this._container.innerHTML=t.localizeAndRender(this._text);let n=!1;for(const t of this._conditionalStyles)if(e.eval(t.conditionExpression)){this._container.className=t.classNames.join(" "),n=!0;break}n||(this._container.className="")}}class _e extends se{constructor(t,e,n,i){if(super(t,e),this._itemsByTriggeringVariable={},this._expressionEvaluator=n,!i||!i.items)return;const r=this.createAndAddChild("div","stats_left"),o=this.createAndAddChild("div","stats_right");for(const t of i.items){e.getLocalizationDictionary().addRequiredKey(t.text);const i=document.createElement("p"),s=new ye(i,n,t);if(t.side&&"left"!==t.side){if("right"!==t.side)throw new Error(`Unknown side: ${t.side}.`);o.appendChild(i)}else r.appendChild(i);if(t.updateTrigger)for(const e of t.updateTrigger.variables)e in this._itemsByTriggeringVariable?this._itemsByTriggeringVariable[e].push(s):this._itemsByTriggeringVariable[e]=[s]}}handleVariableUpdate(t,e){if(!e.clear&&e.varName in this._itemsByTriggeringVariable)for(const t of this._itemsByTriggeringVariable[e.varName])t.update(this._textEngine,this._expressionEvaluator)}}class we extends se{constructor(t,e,n,i){super(t,e),this._gameEngine=n,this._statsBar=new _e(this.retrieveElement("stats_bar"),e,n.expressionEngine,i.statsBar),this._messageWindow=new ue(this.retrieveElement("message_window"),e,i.messageWindow),this._modalBox=new ae(this.retrieveElement("modal_container"),e),this._itemList=new de(this.retrieveElement("items_window"),e,this._gameEngine.inventory,this._gameEngine.itemRegistry,i.itemList),this._statusList=new fe(this.retrieveElement("status_window"),e,this._gameEngine.statusTable,this._gameEngine.statusRegistry,i.statusList),this._footer=new ge(this.retrieveElement("footer"),e,this._modalBox,i.footer),this._fx=new me(this.retrieveElement("fx_container"),e),this._gameEngine.variableStore.onVariableChanged=(t,e)=>{this.handleVariableUpdate(t,e)},this._itemList.onItemClicked=t=>{this._modalBox.display(t.unlocalizedName,t.unlocalizedDescription,"ui.ok",t.icon)},this._statusList.onItemClicked=t=>{this._modalBox.display(t.unlocalizedName,t.unlocalizedDescription,"ui.ok",t.icon)}}playFx(t){if("confetti"!==t)throw new Error(`Unknown fx "${t}".`);this._fx.confetti()}retrieveElement(t){let e=document.getElementById(t);if(!e)throw new Error(`Unable to find #${t}.`);return e}handleVariableUpdate(t,e){this._statsBar.handleVariableUpdate(t,e)}displayMessage(t,e,n,i){return i&&this.playFx(i),this._messageWindow.displayMessage(t,e,n)}displayChoices(t,e,n){return this._messageWindow.displayChoices(t,e,n)}}var be=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};function ve(t,e){return be(this,void 0,void 0,(function*(){return new Promise(((n,i)=>{const r=new XMLHttpRequest;r.open("GET",t,!0),r.onreadystatechange=()=>{r.readyState==XMLHttpRequest.DONE&&(200==r.status?n(e(r.responseText)):i(new Error("Error status: "+r.statusText)))},r.send()}))}))}var xe=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class Ee{constructor(){this._dict=new Map,this._requiredTranslationKeys=new Set}addTranslation(t,e){this._dict.set(t,e)}addRequiredKey(t){this._requiredTranslationKeys.add(t)}translate(t){const e=this._dict.get(t);return null==e?t:e}dumpMissingTranslationKeys(){let t=[];for(const e of this._requiredTranslationKeys)this._dict.has(e)||t.push(e);return t.sort(),t}dumpRequiredTranslationKeys(){let t=[...this._requiredTranslationKeys];return t.sort(),t}dumpUnnecessaryTranslationKeys(){let t=[];for(const e of this._dict.keys())this._requiredTranslationKeys.has(e)||t.push(e);return t.sort(),t}loadFrom(t){return xe(this,void 0,void 0,(function*(){let e=yield ve(t,Ft);if(null==e)throw new Error(`Failed to load translation file from: ${t}`);let n=0;for(let t in e){const i=e[t];if("string"!=typeof i)throw new Error(`Translation of "${t}" should be a string.`);this.addTranslation(t,i),++n}console.log(`Successfully loaded ${n} translations.`)}))}}function Ae(t){return"number"==typeof t||"string"==typeof t&&("NaN"===t||"Infinity"===t||"-Infinity"===t)}function Ce(t){return isNaN(t)?"NaN":isFinite(t)?t:t>0?"Infinity":"-Infinity"}function Se(t){if("string"==typeof t){if("NaN"===t)return NaN;if("Infinity"===t)return 1/0;if("-Infinity"===t)return-1/0;throw new Error("Unable to decode "+t)}return t}class ke{constructor(t,e,n,i){this.clear=t,this.varName=e,this.oldValue=n,this.newValue=i}}class Te{constructor(){this._variables={},this._varLimits={}}setVar(t,e,n=!1){if(n&&!(t in this._variables))throw new Error(`Variable "${t}" does not exist.`);this._varLimits[t]&&(e>this._varLimits[t][1]&&(e=this._varLimits[t][1]),e<this._varLimits[t][0]&&(e=this._varLimits[t][0]));let i=this._variables[t];if(this._variables[t]=e,i!==e){const n=new ke(!1,t,i,e);setTimeout((()=>this.dispatchChangeEvent(n)),0)}}setVarLimits(t,e,n){if(isNaN(e))throw new Error("Lower bound cannot be NaN");if(isNaN(n))throw new Error("Upper bound cannot be NaN");if(e>n)throw new Error("Lower bound cannot be greater than upper bound.");if(this._varLimits[t]=[e,n],!(t in this._variables))return;const i=this._variables[t];if(i<e){this._variables[t]=e;const n=new ke(!1,t,i,e);setTimeout((()=>this.dispatchChangeEvent(n)),0)}else if(i>n){this._variables[t]=n;const e=new ke(!1,t,i,n);setTimeout((()=>this.dispatchChangeEvent(e)),0)}}getVarLimits(t){let e=this._varLimits[t];return e?[e[0],e[1]]:[-1/0,1/0]}getVar(t,e=!0){let n=this._variables[t];if(void 0===n&&t.includes("."))try{const e=t.split(".");let i=window.game||globalThis;for(const t of e)if(i=null==i?void 0:i[t],void 0===i)break;n=i}catch(e){throw new Error(`Failed to resolve variable "${t}": ${e.message}`)}return null==n&&e&&console.warn(`Variable "${t}" does not exist.`),n}reset(){this.dispatchChangeEvent(new ke(!0,"",0,0)),this._variables={}}dumpToConsole(){let t=[];t.push("[Variables (Limits)]");for(let e in this._variables){const n=this._varLimits[e],i=n?` ([${n[0]}, ${n[1]}])`:"";t.push(`${e}: ${this._variables[e]}${i}`)}console.log(t.join("\n"))}decodeFromJson(t){if(null===t||"object"!=typeof t||Array.isArray(t))throw new Error("Non-null JSON object expected.");this.reset();for(const e in t){const n=t[e];if(Ae(n))this.setVar(e,Se(n));else if(Array.isArray(n)){if(3!==n.length)throw new Error("Expect 3 elements: value, lower bound, upper bound.");const[t,i,r]=n;if(!Ae(t))throw new Error("Invalid variable value.");if(!Ae(i))throw new Error("Invalid variable lower bound.");if(!Ae(r))throw new Error("Invalid variable upper bound.");this.setVar(e,Se(t)),this.setVarLimits(e,Se(i),Se(r))}}}encodeAsJson(){let t={};for(const e in this._variables){const n=this._variables[e];if(e in this._varLimits){const[i,r]=this._varLimits[e];t[e]=[Ce(n),Ce(i),Ce(r)]}else t[e]=Ce(n)}return t}dispatchChangeEvent(t){this.onVariableChanged&&this.onVariableChanged(this,t)}}class Ie{constructor(){this._items=new Map}add(t){const e=this._items.get(t.id);if(null!=e&&e!==t)throw new Error("Cannot register two different items under the same id.");this._items.set(t.id,t)}has(t){return"string"==typeof t?this._items.has(t):this._items.get(t.id)===t}get(t){const e=this._items.get(t);if(null==e)throw new Error(`"${t}" does not exist in "${this.name}".`);return e}forEach(t){for(let e of this._items.values())t(e)}}var Ne,Oe=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class Me{constructor(t,e,n=-1/0,i=1/0){this._id=t,this._baseValue=e,this._minValue=n,this._maxValue=i}get id(){return this._id}get baseValue(){return this._baseValue}get minValue(){return this._minValue}get maxValue(){return this._maxValue}}class je extends Ie{get name(){return"attributes"}loadAttributes(t){return Oe(this,void 0,void 0,(function*(){let e=yield ve(t,Ft);if(null==e)return;if(!("attributes"in e)||!Array.isArray(e.attributes))throw new Error("Expect an array of attribute definitions.");const n=e.attributes;for(let t of n){if(!("id"in t)||"string"!=typeof t.id)throw new Error("Missing valid attribute id definition.");const e=t.id;if(!("baseValue"in t)||"number"!=typeof t.baseValue)throw new Error("Missing valid base value definition.");const n=t.baseValue;let i=-1/0;if("minValue"in t){if("number"!=typeof t.minValue||isNaN(t.minValue))throw new Error("minValue must be a valid number.");i=t.minValue}let r=1/0;if("maxValue"in t){if("number"!=typeof t.maxValue||isNaN(t.maxValue))throw new Error("maxValue must be a valid number.");r=t.maxValue}this.add(new Me(e,n,i,r))}console.log(`Successfully registered ${n.length} attributes.`)}))}}!function(t){t[t.Absolute=0]="Absolute",t[t.Relative=1]="Relative",t[t.RelativeToBase=2]="RelativeToBase"}(Ne||(Ne={}));class Fe{constructor(t,e,n){this._target=t,this._type=e,this._amount=n}get target(){return this._target}get type(){return this._type}get amount(){return this._amount}static fromObject(t,e){if(!("target"in t)||"string"!=typeof t.target)throw new Error("Expect `target` to be a valid string.");const n=t.target;if(!e.has(n))throw new Error(`Attribute "${n}" does not exist.`);if(!("type"in t)||"string"!=typeof t.type)throw new Error("Expect `type` to be a string.");let i=Ne.Absolute;switch(t.type){case Ne[Ne.Absolute]:i=Ne.Absolute;break;case Ne[Ne.Relative]:i=Ne.Relative;break;case Ne[Ne.RelativeToBase]:i=Ne.RelativeToBase;break;default:throw new Error(`Unknown attribute modifier type: ${t.type}.`)}if(!("amount"in t)||"number"!=typeof t.amount||isNaN(t.amount))throw new Error("Expect `amount` to be a valid number.");return new Fe(n,i,t.amount)}static CalculateAttributeValue(t,e){let n=t.baseValue;return n*=1+e.relativeToBase,n+=e.absolute,n*=1+e.relative,Math.max(Math.min(n,t.maxValue),t.minValue)}}function De(t,e){let n=[];for(const i of t){if(!("attributeModifiers"in i))continue;if(!Array.isArray(i.attributeModifiers))throw new Error("Expect `attributeModifiers` to be an array.");let t=[];for(const n of i.attributeModifiers)t.push(Fe.fromObject(n,e));n.push({attributeModifiers:t})}return n}class Le{constructor(t,e,n,i){this.clear=t,this.item=e,this.oldCount=n,this.newCount=i}}class ze{constructor(t){this._items={},this._registry=t}get maxStackSize(){return 1/0}get items(){return this._items}add(t,e=1){if("string"==typeof t&&(t=this._registry.get(t)),e<0||Math.floor(e)!==e)throw new Error("Count must be a positive integer.");if(null==this._items[t.id])this._items[t.id]=[t,e],this.dispatchChangeEvent(new Le(!1,t,0,e));else{let n=this._items[t.id][1];this._items[t.id][1]+=e,this._items[t.id][1]>this.maxStackSize&&(this._items[t.id][1]=this.maxStackSize),this.dispatchChangeEvent(new Le(!1,t,this._items[t.id][1],n))}}remove(t,e=1){if("string"==typeof t&&(t=this._registry.get(t)),e<0||Math.floor(e)!==e)throw new Error("Count must be a positive integer.");if(null==this._items[t.id])return;let n=this._items[t.id][1];this._items[t.id][1]-=e,this._items[t.id][1]<=0?(delete this._items[t.id],this.dispatchChangeEvent(new Le(!1,t,0,n))):this.dispatchChangeEvent(new Le(!1,t,this._items[t.id][1],n))}clear(){this.dispatchChangeEvent(new Le(!0,void 0,0,0)),this._items={}}count(t){return"string"==typeof t&&(t=this._registry.get(t)),this._items[t.id]?this.items[t.id][1]:0}getCombinedAttributeModifierAmountsOf(t){let e=0,n=0,i=0;for(const r in this._items){const o=this._items[r][0].getEffects();for(const r of o)for(const o of r.attributeModifiers)if(o.target===t.id)switch(o.type){case Ne.Absolute:e+=o.amount;break;case Ne.Relative:n+=o.amount;break;case Ne.RelativeToBase:i+=o.amount}}return{absolute:e,relative:n,relativeToBase:i}}dispatchChangeEvent(t){this.onChanged&&this.onChanged(this,t)}}var Re,Ke=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class $e{constructor(t,e,n="",i=[]){this._id=t,this._rarity=e,this._icon=n,this._effects=i}get id(){return this._id}get unlocalizedName(){return"item."+this.id}get unlocalizedDescription(){return this.unlocalizedName+".description"}get rarity(){return this._rarity}get icon(){return this._icon}getEffects(){return this._effects}}class Pe extends Ie{constructor(t){super(),this._attributeRegistry=t}get name(){return"items"}loadItems(t){return Ke(this,void 0,void 0,(function*(){let e=yield ve(t,Ft);if(!e)return;if(!Array.isArray(e.items))throw new Error("Expecting an array of item definitions.");let n=e.items;for(let t of n){if("string"!=typeof t.id)throw new Error("Missing item id.");let e;e=Array.isArray(t.effects)?De(t.effects,this._attributeRegistry):[];let n="number"==typeof t.rarity?t.rarity:0,i="string"==typeof t.icon?t.icon:"";this.add(new $e(t.id,n,i,e))}console.log(`Successfully registered ${n.length} items.`)}))}}class Ve extends ze{decodeFromJson(t){if(null===t||!Array.isArray(t))throw new Error("Array expected.");this.clear();for(const e of t){if(!Array.isArray(e)||2!==e.length||"string"!=typeof e[0]||"number"!=typeof e[1])throw new Error("Each saved item data should be a two-element tuple of the item id string and the amount number.");this.add(e[0],e[1])}}encodeAsJson(){let t=new Array;for(const e in this._items)t.push([e,this._items[e][1]]);return t}}class Be{constructor(t){this._data=[],this._comparator=t||((t,e)=>t<e)}get length(){return this._data.length}empty(){return 0===this._data.length}push(t){this._data.push(t),this._heapUp(this._data.length-1)}pop(){if(0===this._data.length)throw new Error("Cannot pop from an empty queue.");const t=this._data[0];return 1===this._data.length?(this._data.pop(),t):(this._swap(0,this._data.length-1),this._data.pop(),this._heapDown(0),t)}top(){if(0===this._data.length)throw new Error("Cannot access the top element of an empty queue.");return this._data[0]}clear(){this._data=[]}_swap(t,e){const n=this._data[t];this._data[t]=this._data[e],this._data[e]=n}_heapUp(t){if(0!==t)for(;t>0;){const e=t-1>>1;if(!this._comparator(this._data[e],this._data[t]))break;this._swap(e,t),t=e}}_heapDown(t){if(!(this._data.length<=1))for(;t<this._data.length;){const e=t+1<<1,n=e-1;if(n>=this._data.length)break;if(e>=this._data.length){if(!this._comparator(this._data[t],this._data[n]))break;this._swap(t,n),t=n}else{const i=this._comparator(this._data[n],this._data[e])?e:n;if(!this._comparator(this._data[t],this._data[i]))break;this._swap(t,i),t=i}}}}class Ue{constructor(t=new Set,e=!1){this._set=t,this._built=e}add(...t){this.addAll(t)}addAll(t){if(this._built)throw new Error("Cannot add element(s) after the set is built!");for(let e of t)this._set.add(e)}get(){return this._built=!0,this._set}}class qe{check(t){throw new Error("Not implemented.")}}!function(t){t[t.Ok=0]="Ok",t[t.StopExecutionLocally=1]="StopExecutionLocally",t[t.StopExecutionGlobally=2]="StopExecutionGlobally"}(Re||(Re={}));const Je=new Set;class Ge{collectTranslationKeys(){return Je}}class We{constructor(t,e=-1){this._actions=t,this._nextIndex=e}get actions(){return this._actions}execute(t){if(this._nextIndex>=0)throw new Error("Already executing.");return this._nextIndex=0,this._executeNext(t)}collectTranslationKeys(){const t=new Ue;for(let e of this._actions)t.addAll(e.collectTranslationKeys());return t.get()}_executeNext(t){for(;this._nextIndex>=0&&this._nextIndex<this._actions.length;){const e=this._actions[this._nextIndex];++this._nextIndex;const n=e.execute(t);if("number"!=typeof n)return n.then((e=>e===Re.Ok?this._executeNext(t):(this._nextIndex=-1,e===Re.StopExecutionLocally?Re.Ok:Re.StopExecutionGlobally)));if(n!==Re.Ok)return this._nextIndex=-1,n===Re.StopExecutionLocally?Re.Ok:Re.StopExecutionGlobally}return this._nextIndex=-1,Re.Ok}}const He=new We([]);class Ye{constructor(t,e,n=[],i=He,r=1,o=[],s=!1,a=!1,c=0){this._id=t,this._trigger=e,this._conditions=n,this._actions=i,this._probability=r,this._exclusions=o,this._once=s,this._disabledByDefault=a,this._priority=c}get id(){return this._id}get trigger(){return this._trigger}get conditions(){return this._conditions}get actions(){return this._actions}get probability(){return this._probability}get exclusions(){return this._exclusions}get once(){return this._once}get disabledByDefault(){return this._disabledByDefault}get priority(){return this._priority}collectTranslationKeys(){return this._actions.collectTranslationKeys()}}var Xe,Ze=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};function Qe(t,e){return t.priority!==e.priority?t.priority<e.priority:t.order!==e.order?t.order>e.order:t.id<e.id}class tn{constructor(){this._eventsByTrigger=new Map,this._eventInfoById=new Map,this._pendingTriggers=new Be(Qe),this._pendingTriggerOrder=0,this._ongoingTrigger=null}enableEvent(t){let e=this._eventInfoById.get(t);if(null==e)throw new Error(`Event "${t}" does not exist.`);e.disabled=!1}disableEvent(t){let e=this._eventInfoById.get(t);if(null==e)throw new Error(`Event "${t}" does not exist.`);e.disabled=!0}registerEvents(t){for(let e of t)this.registerEvent(e)}registerEvent(t){if(this._eventInfoById.has(t.id))throw new Error(`Event "${t.id}" is already registered.`);this._eventInfoById.set(t.id,{event:t,disabled:t.disabledByDefault,occurrenceCount:0});let e=this._eventsByTrigger.get(t.trigger);null==e?this._eventsByTrigger.set(t.trigger,[t]):e.push(t)}unregisterEvent(t){if(!this._eventInfoById.has(t.id))return;this._eventInfoById.delete(t.id);let e=this._eventsByTrigger.get(t.trigger);if(null!=e){const n=e.indexOf(t);if(n>=0)return e.splice(n,1),void(0===e.length&&this._eventsByTrigger.delete(t.trigger))}throw new Error("Invariance broken: event has info entry but not registered under any trigger id.")}getEvents(){let t=[];for(let e of this._eventInfoById.values())t.push(e.event);return t}getEventOccurrenceCount(t){const e=this._eventInfoById.get(t);return null==e?0:e.occurrenceCount}trigger(t,e,n){if(0===t.length)throw new Error("Trigger id cannot be empty.");this._pendingTriggers.push({id:t,priority:n,order:this._pendingTriggerOrder++,probability:e})}processNextTrigger(t){return Ze(this,void 0,void 0,(function*(){if(this._pendingTriggers.empty())return!1;const e=this._pendingTriggers.pop();if(e.probability<=0||e.probability<1&&t.random.next()>e.probability)return!this._pendingTriggers.empty();if(null!=this._ongoingTrigger)throw new Error(`Cannot process the next trigger when the ongoing trigger "${this._ongoingTrigger}" is still being processed.`);const n=e.id;this._ongoingTrigger=n;const i=this._eventsByTrigger.get(n);if(null==i)return!this._pendingTriggers.empty();let r={};const o=[...i].sort(((t,e)=>e.priority-t.priority));for(let e of o){const n=this._eventInfoById.get(e.id);if(n.disabled)continue;if(r[e.id])continue;let i=!1;for(let n of e.conditions)if(!n.check(t)){i=!0;break}if(i)continue;const o="number"==typeof e.probability?e.probability:t.evaluator.eval(e.probability);if(o<=0||o<1&&t.random.next()>o)continue;for(let t of e.exclusions)r[t]=!0;++n.occurrenceCount;const s=yield e.actions.execute(t);if(e.once&&(n.disabled=!0),s===Re.StopExecutionGlobally)break}return this._ongoingTrigger=null,!this._pendingTriggers.empty()}))}reset(){if(null!=this._ongoingTrigger)throw new Error(`Cannot reset the engine when the ongoing trigger "${this._ongoingTrigger}" is still being processed.`);for(let t of this._eventInfoById.values())t.disabled=t.event.disabledByDefault,t.occurrenceCount=0;this._pendingTriggers.clear(),this._pendingTriggerOrder=0}}!function(t){t[t.Name=0]="Name",t[t.Number=1]="Number",t[t.Boolean=2]="Boolean",t[t.String=3]="String",t[t.Operator=4]="Operator",t[t.Delimiter=5]="Delimiter",t[t.Whitespace=6]="Whitespace"}(Xe||(Xe={}));const en=[{tokenType:Xe.Whitespace,regex:/^\s+/g},{tokenType:Xe.Boolean,regex:/^true|^false/},{tokenType:Xe.Name,regex:/^[a-z_$][a-z0-9_$]*(\.[a-z_$][a-z0-9_$]*)*/i},{tokenType:Xe.Number,regex:/^[+-]?Infinity|^NaN|^(\d+(\.\d+)?([Ee][+-]?\d+)?)/},{tokenType:Xe.String,regex:/^'(\\['\\]|[^'])*'/},{tokenType:Xe.Operator,regex:/^(\+|-|\*|\/|%|\(|\)|>=|>|<=|<|&&|&|\|\||\||!|:|\?|===|==|!==|!=)/},{tokenType:Xe.Delimiter,regex:/^,/}];function nn(t){return/^[a-z_$][a-z0-9_$]*(\.[a-z_$][a-z0-9_$]*)*$/i.test(t)}function rn(t,e){const n=function(t){let e=[];for(;t.length>0;){let n=!1;for(let i of en){let r=i.regex.exec(t);if(r){n=!0,i.tokenType!==Xe.Whitespace&&e.push({type:i.tokenType,text:r[0]}),t=t.slice(r[0].length);break}}if(!n)throw new Error(`Invalid syntax starting at: ${t}`)}return e}(t);let i='"use strict";\nreturn (',r=0;for(;r<n.length;){const t=n[r];switch(t.type){case Xe.Name:if(t.text.indexOf(".")>0||r>=n.length-2||n[r+1].type!==Xe.Operator||"("!==n[r+1].text)i+=`__functions.getVar('${t.text}')`;else{if(!e.existsFunction(t.text))throw new Error(`Unsupported function "${t.text}".`);i+="__functions."+t.text}break;case Xe.Number:case Xe.Boolean:case Xe.Operator:case Xe.String:case Xe.Delimiter:i+=t.text;break;default:throw new Error("Unexpected token type.")}++r}return i+=");",{source:t,fn:new Function("__functions",i)}}class on{constructor(t,e,n,i,r,o){this._cache={},this._variableStore=t,this._attributes=e,this._inventory=n,this._statusTable=i,this._random=r,this._eventOccurrenceTracker=o,this._fTable=this._initFunctionTable()}_initFunctionTable(){return{getVar:t=>this._variableStore.getVar(t,!0),setVarLimits:(t,e,n)=>this._variableStore.setVarLimits(t,e,n),eventOccurred:t=>this._eventOccurrenceTracker.getEventOccurrenceCount(t)>0,upperBound:t=>this._variableStore.getVarLimits(t)[1],lowerBound:t=>this._variableStore.getVarLimits(t)[0],itemCount:t=>this._inventory.count(t),totalMonths:()=>12*this._variableStore.getVar("year",!0)+this._variableStore.getVar("month",!0),getAttributeValue:t=>{const e=this._attributes.get(t),n=this._inventory.getCombinedAttributeModifierAmountsOf(e),i=this._statusTable.getCombinedAttributeModifierAmountsOf(e);return Fe.CalculateAttributeValue(e,{absolute:n.absolute+i.absolute,relative:n.relative+i.relative,relativeToBase:n.relativeToBase+i.relativeToBase})},hasStatus:t=>this._statusTable.count(t)>0,random:()=>this._random.next(),randi:t=>Math.floor(this._random.next()*t),max:Math.max,min:Math.min,floor:Math.floor,round:Math.round,ceil:Math.ceil,clip:(t,e,n)=>t<e?t:t>n?n:t}}getClosure(){return this._fTable}existsFunction(t){return null!=this._fTable[t]}compile(t){return"number"==typeof t?{source:t.toString(),fn:()=>t}:(this._cache[t]||(this._cache[t]=rn(t,this)),this._cache[t])}eval(t){let e=t.fn(this.getClosure());if(isNaN(e))throw new Error("Expression produced NaN.");return e}}var sn,an=n(377);function cn(t,e){if(0===t.length)throw new Error("Must have at least one weight value.");let n=new Array(t.length+1),i=0;for(let e=0;e<t.length;e++){if(n[e]=i,t[e]<0)throw new Error("Weights cannot be negative.");i+=t[e]}if(n[n.length-1]=i,0===i)throw new Error("Sum of weights must be positive.");let r=e()*i,o=0;for(;o<t.length&&!(r>=n[o]&&r<n[o+1]);o++);return o}class ln{constructor(t){this._seed=t,this._random=an.alea(t,{state:!0})}get seed(){return this._seed}next(){return this._random.double()}reset(t){null==t?t=this._seed:this._seed=t,this._random=an.alea(t,{state:!0})}}!function(t){t[t.None=0]="None",t[t.Win=1]="Win",t[t.Loss=2]="Loss"}(sn||(sn={}));class un{constructor(t){this._key=t}getTranslationKey(t){return this._key}collectTranslationKeys(){return new Set([this._key])}}class hn{constructor(t,e){if(this._keySources=t,this._weights=e,this._keySources.length!==this._weights.length)throw new Error("The number of TranslationKeySources is not equal to the number of weight expressions.");if(0===this._keySources.length)throw new Error("At least one TranslationKeySource is required.")}getTranslationKey(t){const e=cn(this._weights.map((e=>t.evaluator.eval(e))),(()=>t.random.next()));return this._keySources[e].getTranslationKey(t)}collectTranslationKeys(){const t=new Ue;for(const e of this._keySources)t.addAll(e.collectTranslationKeys());return t.get()}}class dn{constructor(t,e,n){if(this._defaultKey=t,this._conditions=e,this._keySources=n,this._keySources.length!==this._conditions.length)throw new Error("The number of TranslationKeySources is not equal to the number of conditions.")}getTranslationKey(t){for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].check(t))return this._keySources[e].getTranslationKey(t);return this._defaultKey.getTranslationKey(t)}collectTranslationKeys(){const t=new Ue(this._defaultKey.collectTranslationKeys());for(const e of this._keySources)t.addAll(e.collectTranslationKeys());return t.get()}}class fn{constructor(t,e){this._conditionFactory=t,this._expressionCompiler=e}fromObject(t){if("string"==typeof t)return new un(t);if(Array.isArray(t)){if(0===t.length)throw new Error("The array of TranslationKeySource definitions cannot be empty.");let e=[],n=[];if("object"==typeof t[0]&&"weight"in t[0]&&"text"in t[0])for(const i of t){const t=i.weight;if(null==t)throw new Error('"weight" is not defined.');if("number"!=typeof t&&"string"!=typeof t)throw new Error("Weight must be a number or a string defining an expression.");n.push(this._expressionCompiler.compile(t));const r=i.text;if(null==r)throw new Error('"text" is not defined.');e.push(this.fromObject(r))}else for(const i of t)e.push(this.fromObject(i)),n.push(this._expressionCompiler.compile(1));return new hn(e,n)}if("object"==typeof t&&"default"in t&&"branches"in t){const e=this.fromObject(t.default);if(!Array.isArray(t.branches))throw new Error('"branches" should be an array.');let n=[],i=[];for(const e of t.branches)n.push(this._conditionFactory.fromJSON(e.condition)),i.push(this.fromObject(e.text));return new dn(e,n,i)}throw new Error("Unrecognized TranslationKeySource definition.")}}class pn{constructor(t=5){this.messages=[],this.maxMessages=t}getMessages(){return this.messages.length>this.maxMessages&&(this.messages=this.messages.slice(-this.maxMessages)),this.messages.map((t=>`${"human"===t.type?"玩家":"NPC"}: ${t.content}`)).join("\n")}addMessage(t,e){this.messages.push({type:"human",content:t}),this.messages.push({type:"ai",content:e})}}class mn{constructor(){this.npcs=[{id:1,name:"林教授",age:45,gender:"男",occupation:"大学教授",personality:"严谨、耐心、知识渊博",likes:["学术讨论","历史","科学"],dislikes:["肤浅的聊天","浪费时间"]},{id:2,name:"小王",age:20,gender:"男",occupation:"学生",personality:"活泼、好奇、有点害羞",likes:["游戏","音乐","运动"],dislikes:["考试","早起"]},{id:3,name:"学长",age:22,gender:"男",occupation:"学生",personality:"严肃、认真、有条理",likes:["学习","阅读","思考"],dislikes:["玩手机","睡懒觉"]},{id:4,name:"HR",age:30,gender:"男",occupation:"HR",personality:"热情、积极、有责任心",likes:["招聘","面试","工作"],dislikes:["拖延","不专业"]}],this.memory=new Map}getNPC(t){return this.npcs.find((e=>e.id===t))}getMemory(t){return this.memory.has(t)||this.memory.set(t,new pn(5)),this.memory.get(t)}addNPC(t){this.npcs.push(t)}}var gn=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class yn{constructor(t="/api/llm/chat"){this.apiUrl=t}createChatChain(t,e){return{invoke:n=>gn(this,void 0,void 0,(function*(){const i=e?e.getMessages():"",r=[{role:"system",content:`你是 ${t.name}，${t.occupation}，性格：${t.personality}。`},...i?[{role:"assistant",content:i}]:[],{role:"user",content:n.player_input}];console.log("[ChatSystem] invoking /api/llm/chat",{apiUrl:this.apiUrl,npcId:t.id,player_input:n.player_input,messagesPreview:r.slice(0,3)});const o=yield fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({npc:t,playerInput:n.player_input,chatHistory:i,messages:r})});if(console.log("[ChatSystem] fetch completed, status=",o.status),!o.ok){const t=yield o.text().catch((()=>"<no body>"));throw new Error(`HTTP error! status: ${o.status}, body: ${t}`)}const s=yield o.json();if("string"==typeof s)return s;if(s.text)return s.text;if(Array.isArray(s)&&s[0]&&s[0].text)return s[0].text;if(s.choices&&s.choices[0]){const t=s.choices[0].message;if(t&&t.content)return t.content;if(s.choices[0].text)return s.choices[0].text}throw new Error("Unexpected chat API response format")}))}}}var _n=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class wn{constructor(){this.npcSystem=new mn,this.chatSystem=new yn}generate(t,e){return _n(this,void 0,void 0,(function*(){return`Response: ${t}`}))}chatWithNPC(t,e,n){return _n(this,void 0,void 0,(function*(){try{const n=this.npcSystem.getNPC(t);if(!n)throw new Error(`NPC with id ${t} not found`);const i=this.npcSystem.getMemory(t),r=this.chatSystem.createChatChain(n,i),o=yield r.invoke({player_input:e});try{i&&"function"==typeof i.addMessage&&(yield i.addMessage(e,o))}catch(t){console.warn("Failed to save NPC memory:",t)}return o}catch(t){return console.error("LangChainLLMProvider chatWithNPC error:",t),"抱歉，我现在无法回应。"}}))}}let bn=new wn;function vn(){return bn}var xn=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class En extends Ge{constructor(t){super(),this.npcId=t.npcId,this.promptKey=t.prompt,this.npcNameKey=t.npcName}execute(t){return xn(this,void 0,void 0,(function*(){const e=this.promptKey,n=this.npcNameKey,i=window.prompt(e,"");if(!i||!i.trim())return Re.Ok;yield t.actionProxy.displayMessage(`${n}正在思考...`,"OK");const r=`${e}\nPlayer: ${i.trim()}\nNPC:`;let o={variables:t.variableStore.encodeAsJson()};try{const e=vn(),s=15e3,a=e.chatWithNPC?e.chatWithNPC(this.npcId,i.trim(),o):e.generate(r,o),c=yield Promise.race([a,new Promise(((t,e)=>setTimeout((()=>e(new Error("LLM timeout"))),s)))]);console.log("LLM response:",c),yield t.actionProxy.displayMessage(`${n}: ${c}`,"OK")}catch(e){console.error("NPC chat execution error:",e),yield t.actionProxy.displayMessage(`${n}: 抱歉，我现在无法回应。`,"OK")}return Re.Ok}))}serialize(){return{type:"EANPCChat",npcId:this.npcId,prompt:this.promptKey,npcName:this.npcNameKey}}static deserialize(t){return new En(t)}}var An=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class Cn{constructor(t,e){this._deserializers=new Map,this._deserializationContext={actionFactory:this,conditionFactory:t,translationKeySourceFactory:new fn(t,e),expressionCompiler:e}}registerDeserializer(t){this._deserializers.set(t.ID,t.fromJSONObject)}fromJSONObject(t){if(!t.id)throw new Error("Action id is not specified.");const e=t.id;if("string"!=typeof e)throw new Error("Action id must be a string.");const n=this._deserializers.get(e);if(null==n)throw new Error(`No deserializer defined for "${e}".`);return n(t,this._deserializationContext)}fromJSONArray(t){let e=new Array(t.length);for(let n=0;n<t.length;n++)e[n]=this.fromJSONObject(t[n]);return e}}class Sn extends Ge{constructor(t,e){super(),this._message=t,this._dumpVariables=e}static fromJSONObject(t,e){if(null==t.message)throw new Error("Message missing.");return new Sn(t.message,t.dumpVariables||!1)}execute(t){return console.log(this._message),this._dumpVariables&&t.variableStore.dumpToConsole(),Re.Ok}}Sn.ID="Log";class kn extends Ge{constructor(t,e,n){super(),this._message=t,this._confirm=e,this._icon=n}static fromJSONObject(t,e){if(null==t.message)throw new Error("Message missing.");if(null==t.confirm)throw new Error("Confirm message missing.");return new kn(e.translationKeySourceFactory.fromObject(t.message),e.translationKeySourceFactory.fromObject(t.confirm),t.icon||"")}execute(t){return t.actionProxy.displayMessage(this._message.getTranslationKey(t),this._confirm.getTranslationKey(t),this._icon).then((()=>Re.Ok))}collectTranslationKeys(){const t=new Ue;return t.addAll(this._message.collectTranslationKeys()),t.addAll(this._confirm.collectTranslationKeys()),t.get()}}kn.ID="DisplayMessage";class Tn extends Ge{constructor(t,e,n){super(),this._messages=t,this._confirm=e,this._icon=n}static fromJSONObject(t,e){if(!Array.isArray(t.messages))throw new Error("Messages missing.");let n=[];for(const i of t.messages)n.push(e.translationKeySourceFactory.fromObject(i));if("string"!=typeof t.confirm)throw new Error("Confirm message missing.");return new Tn(n,e.translationKeySourceFactory.fromObject(t.confirm),t.icon||"")}execute(t){const e=Math.floor(t.random.next()*this._messages.length);return t.actionProxy.displayMessage(this._messages[e].getTranslationKey(t),this._confirm.getTranslationKey(t),this._icon).then((()=>Re.Ok))}collectTranslationKeys(){const t=new Ue(this._confirm.collectTranslationKeys());for(const e of this._messages)t.addAll(e.collectTranslationKeys());return t.get()}}Tn.ID="DisplayRandomMessage";class In extends Ge{constructor(t,e,n,i,r){if(super(),this._message=t,this._choiceMessages=e,this._requirements=n,this._actions=i,this._icon=r,e.length!==n.length||e.length!==i.length)throw new Error("The number of choices must be equal to the number of requirements/actions.")}static fromJSONObject(t,e){if(null==t.message)throw new Error("Message missing.");const n=e.translationKeySourceFactory.fromObject(t.message);if(!Array.isArray(t.choices))throw new Error("Choices are missing.");let i=[],r=[],o=[];for(const n of t.choices){i.push(e.translationKeySourceFactory.fromObject(n.message));const t=Array.isArray(n.actions)?e.actionFactory.fromJSONArray(n.actions):[];o.push(new We(t)),null!=n.requirement?r.push(e.expressionCompiler.compile(n.requirement)):r.push(e.expressionCompiler.compile("true"))}return new In(n,i,r,o,t.icon||"")}execute(t){let e=[];for(let n=0;n<this._choiceMessages.length;n++)t.evaluator.eval(this._requirements[n])&&e.push([this._choiceMessages[n].getTranslationKey(t),n]);return t.actionProxy.displayChoices(this._message.getTranslationKey(t),e,this._icon).then((e=>this._actions[e].execute(t)))}collectTranslationKeys(){const t=new Ue;t.addAll(this._message.collectTranslationKeys());for(const e of this._choiceMessages)t.addAll(e.collectTranslationKeys());for(const e of this._actions)t.addAll(e.collectTranslationKeys());return t.get()}}In.ID="DisplayChoices";class Nn extends Ge{constructor(t,e,n,i=1){if(super(),t.length!==e.length)throw new Error("The number of weights must match the number of actions.");this._actions=t,this._weightExprs=e,this._condition=n,this._probability=i}static fromJSONObject(t,e){if(!Array.isArray(t.groups))throw new Error("Missing group definitions.");let n,i=[],r=[];for(let n of t.groups){let t=n.weight;if(null==t)throw new Error("Missing weight definition.");if("string"!=typeof t&&"number"!=typeof t)throw new Error("Weight must be a number or an expression.");if(!Array.isArray(n.actions))throw new Error("Missing actions.");i.push(e.expressionCompiler.compile(t)),r.push(new We(e.actionFactory.fromJSONArray(n.actions)))}"string"==typeof t.condition&&(n=e.expressionCompiler.compile(t.condition));let o=1;if(void 0!==t.probability){const e=parseFloat(t.probability);if(isNaN(e)||e<0||e>1)throw new Error("Invalid probability: must be between 0 and 1.");o=e}return new Nn(r,i,n,o)}execute(t){var e;const n=t.evaluator,i=t.random;if(console.log("[Random] execute() called"),console.log("[Random] condition:",this._condition?"exists":"none"),console.log("[Random] probability:",this._probability),this._condition&&!n.eval(this._condition))return console.log("[Random] Condition not met -> skip"),Re.Ok;const r=i.next();if(console.log("[Random] randVal =",r),r>(null!==(e=this._probability)&&void 0!==e?e:1))return console.log(`[Random] Skip due to probability (${r.toFixed(2)} > ${this._probability})`),Re.Ok;const o=this._randomIndex(t);return console.log("[Random] executing group index =",o),this._actions[o].execute(t)}collectTranslationKeys(){const t=new Ue;for(const e of this._actions)t.addAll(e.collectTranslationKeys());return t.get()}_randomIndex(t){return cn(this._weightExprs.map((e=>t.evaluator.eval(e))),(()=>t.random.next()))}}Nn.ID="Random";class On extends Ge{constructor(t,e,n){super(),this._p=t,this._successActionList=e,this._failActionList=n}static fromJSONObject(t,e){const n=t.probability;if("string"!=typeof n&&"number"!=typeof n)throw new Error("Probability must be a number of an expression.");let i=Array.isArray(t.success)?e.actionFactory.fromJSONArray(t.success):[],r=Array.isArray(t.fail)?e.actionFactory.fromJSONArray(t.fail):[];return new On(e.expressionCompiler.compile(n),new We(i),new We(r))}execute(t){return this._coinFlip(t)?this._successActionList.execute(t):this._failActionList.execute(t)}collectTranslationKeys(){const t=new Ue;return t.addAll(this._successActionList.collectTranslationKeys()),t.addAll(this._failActionList.collectTranslationKeys()),t.get()}_coinFlip(t){const e=t.evaluator.eval(this._p);return!(e<0)&&t.random.next()<e}}On.ID="CoinFlip";class Mn extends Ge{constructor(t,e){super(),this._conditions=t,this._actions=e}static fromJSONObject(t,e){const n=t.branches;if(!Array.isArray(n))throw new Error("Expecting an array of branches.");let i=[],r=[];for(let t of n){if(null==t.condition)throw new Error("Condition is required.");if(i.push(e.conditionFactory.fromJSON(t.condition)),!Array.isArray(t.actions))throw new Error("Missing actions.");r.push(new We(e.actionFactory.fromJSONArray(t.actions)))}return new Mn(i,r)}execute(t){for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].check(t))return this._actions[e].execute(t);return Re.Ok}collectTranslationKeys(){const t=new Ue;for(const e of this._actions)t.addAll(e.collectTranslationKeys());return t.get()}}Mn.ID="Switch";class jn extends Ge{constructor(t,e,n,i){super(),this._stopCondition=t,this._maxIterations=e,this._checkStopConditionAtEnd=n,this._actions=i,this._i=-1}static fromJSONObject(t,e){let n=null;const i=t.stopCondition;null!=i&&(n=e.conditionFactory.fromJSON(i));let r=t.maxIterations;if(null==r)r=0;else{if("number"!=typeof r)throw new Error("maxIterations needs to be a number.");r=r>0?r:0}let o=t.checkStopConditionAtEnd;if(null==o)o=!1;else if("boolean"!=typeof o)throw new Error("checkStopConditionAtEnd need to be a boolean.");if(!Array.isArray(t.actions))throw new Error("Missing actions.");const s=e.actionFactory.fromJSONArray(t.actions);return new jn(n,r,o,new We(s))}execute(t){if(this._i>=0)throw new Error("Already executing.");return this._i=0,this._checkStopConditionAtEnd?this._nextDoWhileIteration(t):this._nextWhileDoIteration(t)}collectTranslationKeys(){const t=new Ue;return t.addAll(this._actions.collectTranslationKeys()),t.get()}_nextDoWhileIteration(t){do{const e=this._actions.execute(t);if("number"!=typeof e)return e.then((e=>e===Re.StopExecutionGlobally?(this._i=-1,Re.StopExecutionGlobally):this._maxIterations>0&&++this._i>=this._maxIterations||null!==this._stopCondition&&this._stopCondition.check(t)?(this._i=-1,Re.Ok):this._nextDoWhileIteration(t)));if(e===Re.StopExecutionGlobally)return this._i=-1,Re.StopExecutionGlobally;if(this._maxIterations>0&&++this._i>=this._maxIterations){this._i=-1;break}}while(null===this._stopCondition||!this._stopCondition.check(t));return this._i=-1,Re.Ok}_nextWhileDoIteration(t){for(;null===this._stopCondition||!this._stopCondition.check(t);){const e=this._actions.execute(t);if("number"!=typeof e)return e.then((e=>e===Re.StopExecutionGlobally?(this._i=-1,Re.StopExecutionGlobally):this._maxIterations>0&&++this._i>=this._maxIterations?(this._i=-1,Re.Ok):this._nextWhileDoIteration(t)));if(e===Re.StopExecutionGlobally)return this._i=-1,Re.StopExecutionGlobally;if(this._maxIterations>0&&++this._i>=this._maxIterations){this._i=-1;break}}return this._i=-1,Re.Ok}}jn.ID="Loop";class Fn extends Ge{constructor(t,e){super(),this._varName=t,this._updateExpr=e}static fromJSONObject(t,e){if(!t.variable)throw new Error("Missing variable name.");if(null==t.value)throw new Error("Missing value.");let n=t.value;if("number"!=typeof n&&"string"!=typeof n)throw new Error("Value must be either a number of a string.");return new Fn(t.variable,e.expressionCompiler.compile(n))}execute(t){return t.variableStore.setVar(this._varName,t.evaluator.eval(this._updateExpr),!1),Re.Ok}}Fn.ID="UpdateVariable";class Dn extends Ge{constructor(t,e){if(super(),this._varNames=t,this._updateExprs=e,t.length!==e.length)throw new Error("The number of variables must be equal to the number of expressions.")}static fromJSONObject(t,e){if(!t.updates)throw new Error("Missing update definitions.");let n=[],i=[];for(let r in t.updates)n.push(r),i.push(e.expressionCompiler.compile(t.updates[r]));return new Dn(n,i)}execute(t){for(let e=0;e<this._varNames.length;e++)t.variableStore.setVar(this._varNames[e],t.evaluator.eval(this._updateExprs[e]));return Re.Ok}}Dn.ID="UpdateVariables";class Ln extends Ge{constructor(t){super(),this._limitsByVarName=t}static fromJSONObject(t,e){if(!t.updates)throw new Error("Missing update definitions.");let n={};for(const e in t.updates){let i=t.updates[e];if(!Array.isArray(i)||2!==i.length||"number"!=typeof i[0]||"number"!=typeof i[1])throw new Error("Limits need to be two-element tuples.");n[e]=i}return new Ln(n)}execute(t){for(const e in this._limitsByVarName){const n=this._limitsByVarName[e];t.variableStore.setVarLimits(e,n[0],n[1])}return Re.Ok}}Ln.ID="UpdateVariableLimits";class zn extends Ge{constructor(t,e){super(),this._itemId=t,this._amountExpr=e}static fromJSONObject(t,e){if(null==t.itemId)throw new Error("Missing item id.");if("string"!=typeof t.amount&&"number"!=typeof t.amount)throw new Error("Amount must be a number or an expression.");return new zn(t.itemId,e.expressionCompiler.compile(t.amount))}execute(t){let e=t.evaluator.eval(this._amountExpr);return e>0?t.inventory.add(this._itemId,e):e<0&&t.inventory.remove(this._itemId,-e),Re.Ok}}zn.ID="GiveItem";class Rn extends Ge{constructor(t,e){if(super(),this._itemIds=t,this._updateExprs=e,t.length!==e.length)throw new Error("The number of items must match the number of expressions.")}static fromJSONObject(t,e){if(null==t.updates)throw new Error("Missing update definitions.");let n=[],i=[];for(const r in t.updates)n.push(r),i.push(e.expressionCompiler.compile(t.updates[r]));return new Rn(n,i)}execute(t){for(let e=0;e<this._itemIds.length;e++){const n=this._itemIds[e],i=t.evaluator.eval(this._updateExprs[e]);i>0?t.inventory.add(n,i):i<0&&t.inventory.remove(n,-i)}return Re.Ok}}Rn.ID="UpdateItemAmounts";class Kn extends Ge{constructor(t,e,n,i,r){super(),this._message=t,this._confirm=e,this._winning=n,this._endingType=i,this._fx=r}static fromJSONObject(t,e){if(null==t.message)throw new Error("Missing message.");if(null==t.confirm)throw new Error("Missing confirm message.");if("boolean"!=typeof t.winning)throw new Error("Missing winning status.");if(t.endingType&&"string"!=typeof t.endingType)throw new Error('"endingType" must be a string if set.');if(t.fx&&"string"!=typeof t.fx)throw new Error("FX must be a string.");return new Kn(e.translationKeySourceFactory.fromObject(t.message),e.translationKeySourceFactory.fromObject(t.confirm),t.winning,t.endingType,t.fx)}execute(t){return t.actionProxy.displayMessage(this._message.getTranslationKey(t),this._confirm.getTranslationKey(t),"",this._fx).then((()=>(t.setEndGameState(this._winning?sn.Win:sn.Loss,this._endingType),Re.StopExecutionGlobally)))}collectTranslationKeys(){const t=new Ue;return t.addAll(this._message.collectTranslationKeys()),t.addAll(this._confirm.collectTranslationKeys()),t.get()}}Kn.ID="EndGame";class $n extends Ge{constructor(t,e){super(),this._statusId=t,this._on=e}static fromJSONObject(t,e){if("string"!=typeof t.statusId)throw new Error("Missing status id.");if("boolean"!=typeof t.on)throw new Error("Missing on/off indicator.");return new $n(t.statusId,t.on)}execute(t){return this._on?t.statusTable.add(this._statusId):t.statusTable.remove(this._statusId),Re.Ok}}$n.ID="SetStatus";class Pn extends Ge{constructor(t){super(),this._triggerInfoList=t}static fromJSONObject(t,e){let n=[];if(!t.triggers||!Array.isArray(t.triggers))throw new Error("Missing trigger definitions.");for(const i of t.triggers){let t=i.id;if("string"!=typeof t)throw new Error("Missing valid trigger id.");let r=i.priority||0;if("number"!=typeof r||isNaN(r))throw new Error("Priority must be a valid number.");let o={id:t,priority:r},s=i.probability;if(null!=s){if("string"!=typeof s&&"number"!=typeof s)throw new Error("Invalid probability definition.");o.probability=e.expressionCompiler.compile(s)}n.push(o)}return new Pn(n)}execute(t){for(const e of this._triggerInfoList){const n=null==e.probability?1:t.evaluator.eval(e.probability);t.eventEngine.trigger(e.id,n,e.priority)}return Re.Ok}}Pn.ID="TriggerEvents";class Vn extends Ge{constructor(t){super(),this._eventIds=t}static fromJSONObject(t,e){if(!("eventIds"in t)||!Array.isArray(t.eventIds))throw new Error('Expecting "eventIds" to be an array.');let n=[];for(let e of t.eventIds){if("string"!=typeof e)throw new Error("Expect event id to be a string.");n.push(e)}return new Vn(n)}execute(t){for(const e of this._eventIds)t.eventEngine.enableEvent(e);return Re.Ok}}Vn.ID="EnableEvents";class Bn extends Ge{constructor(t){super(),this._eventIds=t}static fromJSONObject(t,e){if(!("eventIds"in t)||!Array.isArray(t.eventIds))throw new Error('Expecting "eventIds" to be an array.');let n=[];for(let e of t.eventIds){if("string"!=typeof e)throw new Error("Expect event id to be a string.");n.push(e)}return new Bn(n)}execute(t){for(const e of this._eventIds)t.eventEngine.disableEvent(e);return Re.Ok}}Bn.ID="DisableEvents";class Un{static fromJSONObject(t,e){if(null==t.npcId)throw new Error("npcId missing.");if("number"!=typeof t.npcId)throw new Error("npcId must be a number.");if(null==t.prompt)throw new Error("prompt missing.");if("string"!=typeof t.prompt)throw new Error("prompt must be a string.");if(null==t.npcName)throw new Error("npcName missing.");if("string"!=typeof t.npcName)throw new Error("npcName must be a string.");return En.deserialize({npcId:t.npcId,prompt:t.prompt,npcName:t.npcName})}}Un.ID="EANPCChat";class qn extends Ge{constructor(t,e,n){super(),this._npcId=t,this._promptKey=e,this._npcName=n}static fromJSONObject(t,e){if(null==t.npcId)throw new Error("EAExamPrep: npcId missing.");return new qn(Number(t.npcId),t.prompt,t.npcName)}execute(t){return An(this,void 0,void 0,(function*(){const e=this._npcName||"学长";yield t.actionProxy.displayMessage(`${e}正在准备...`,"OK");const n=vn(),i=`\n你是一个经验丰富的学长，正在给即将到来的${this._promptKey||"期中/期末"}考试传授复习与应考经验。\n先用一段简短、实用的建议开场（2-4 句），然后请玩家告诉你他的疑惑，并列出 3 个可供选择的疑惑项（按 1/2/3 编号，每项一句话）。\n最后不要给出答案，只列出选项等待玩家选择。学生专业: 计算机科学。\n请只返回可读文本（第一段为开场建议，随后换行列出编号选项）。\n`.trim();try{const r=15e3,o=n.chatWithNPC?n.chatWithNPC(this._npcId,i,{}):n.generate(i,{}),s=((yield Promise.race([o,new Promise(((t,e)=>setTimeout((()=>e(new Error("LLM timeout"))),r)))]))||"").split(/\r?\n/).map((t=>t.trim())).filter((t=>t)),a=[],c=[];for(const t of s){const e=t.match(/^\s*(?:\d+[\).\、]|[-•]\s*)(.*)$/);e&&e[1]?a.length<3&&a.push(e[1].trim()):a.length>0&&a.length<3?a[a.length-1]+=" "+t:c.push(t)}if(0===a.length){const t=s.slice(-3);for(const e of t)e&&a.push(e)}for(;a.length<3;)a.push("我想要更多复习建议。");const l=c.join(" "),u=a.map(((t,e)=>[t,e])),h=yield t.actionProxy.displayChoices(l||`${e}：请选择你最想问的问题：`,u,"OK"),d="number"==typeof h?h:Number(h)||0,f=`\n你是经验丰富的学长。玩家选择的问题是：${a[Math.max(0,Math.min(d,a.length-1))]}\n请给出针对该问题的详细、可操作的解答（2-6 段或若干要点），并在最后给出一句简短的鼓励语。\n注意回复要面向考试复习与应考策略，结合实例说明。\n`.trim(),p=n.chatWithNPC?n.chatWithNPC(this._npcId,f,{}):n.generate(f,{}),m=yield Promise.race([p,new Promise(((t,e)=>setTimeout((()=>e(new Error("LLM timeout"))),r)))]);yield t.actionProxy.displayMessage(`${e}: ${m}`,"OK")}catch(n){console.error("EAExamPrep error:",n),yield t.actionProxy.displayMessage(`${e}: 抱歉，我现在无法给出建议。`,"OK")}return Re.Ok}))}}qn.ID="EAExamPrep";class Jn extends Ge{constructor(t,e){super(),this._npcId=t,this._npcName=e}static fromJSONObject(t,e){if(null==t.npcId)throw new Error("EAInterview: npcId missing.");return new Jn(Number(t.npcId),t.npcName)}execute(t){return An(this,void 0,void 0,(function*(){const e=this._npcName||"面试官";yield t.actionProxy.displayMessage(`${e}正在准备面试问题...`,"OK");const n=vn(),i="\n你是公司面试官，正在为一名计算机科学专业的学生进行面试。请先给出一段简短的自我介绍（作为面试官），随后提出一个面试问题（聚焦专业能力、算法/工程/系统设计或团队协作等核心竞争力），并给出 3 个可供玩家选择的回答方向（编号 1/2/3）。\n请只输出面试官的自我介绍、问题与三项编号选项（便于玩家选择）。\n".trim();try{const r=15e3,o=n.chatWithNPC?n.chatWithNPC(this._npcId,i,{}):n.generate(i,{}),s=((yield Promise.race([o,new Promise(((t,e)=>setTimeout((()=>e(new Error("LLM timeout"))),r)))]))||"").split(/\r?\n/).map((t=>t.trim())).filter((t=>t)),a=[],c=[];for(const t of s){const e=t.match(/^\s*(?:\d+[\).\、]|[-•]\s*)(.*)$/);e&&e[1]?a.length<3&&a.push(e[1].trim()):a.length>0&&a.length<3?a[a.length-1]+=" "+t:c.push(t)}if(0===a.length){const t=s.slice(-3);for(const e of t)e&&a.push(e)}for(;a.length<3;)a.push("我会诚实回答。");const l=c.join(" "),u=a.map(((t,e)=>[t,e])),h=yield t.actionProxy.displayChoices(l||`${e}：请选择你的回答方向：`,u,"OK"),d="number"==typeof h?h:Number(h)||0,f=`\n你是面试官。应聘者选择的回答方向是：${a[Math.max(0,Math.min(d,a.length-1))]}\n请以面试官的口吻给出对该回答的评价（中肯、简洁），并给出对面试分数的建议（在 -10 到 +10 之间的整数），格式要求：\n评价文本：<你的评价文本>\n分数变化：<整数>\n只返回这两行，便于程序解析。\n`.trim(),p=n.chatWithNPC?n.chatWithNPC(this._npcId,f,{}):n.generate(f,{}),m=yield Promise.race([p,new Promise(((t,e)=>setTimeout((()=>e(new Error("LLM timeout"))),r)))]);let g=0;const y=m.match(/分数变化\s*[:：]\s*([+-]?\d+)/);g=y?Number(y[1])||0:0===d?8:1===d?4:0;let _=0;try{let e;e="function"==typeof t.variableStore.getVar?t.variableStore.getVar("interview.score",!1):void 0,_="number"==typeof e?e:Number(e)||0}catch(t){console.warn("EAInterview: failed to read interview.score, defaulting to 0",t),_=0}const w=_+g;"function"==typeof t.variableStore.setVar?t.variableStore.setVar("interview.score",w):console.warn("EAInterview: variableStore has no setter API. score not saved:",w),yield t.actionProxy.displayMessage(`${e}：${m}`,"OK")}catch(n){console.error("EAInterview error:",n),yield t.actionProxy.displayMessage(`${e}：抱歉，面试暂时无法继续。`,"OK")}return Re.Ok}))}}Jn.ID="EAInterview";class Gn{constructor(t){this._deserializers=new Map,this._deserializationContext={conditionFactory:this,expressionCompiler:t}}registerDeserializer(t){this._deserializers.set(t.ID,t.fromJSONObject)}fromJSONObject(t){if(!("id"in t)||"string"!=typeof t.id)throw new Error("Condition id must be a string.");const e=t.id,n=this._deserializers.get(e);if(null==n)throw new Error(`No deserializer defined for "${e}".`);return n(t,this._deserializationContext)}fromJSON(t){if(null==t)throw new Error("JSON input cannot be null.");if("number"==typeof t||"string"==typeof t)return new Wn(this._deserializationContext.expressionCompiler.compile(t));if("object"==typeof t)return this.fromJSONObject(t);throw new Error("Unsupported JSON input.")}fromJSONArray(t){return t.map((t=>this.fromJSON(t)))}}class Wn extends qe{constructor(t){super(),this._expression=t}static fromJSONObject(t,e){if(!("expression"in t)||null==t.expression)throw new Error("Missing expression.");const n=t.expression;if("number"!=typeof n&&"string"!=typeof n)throw new Error("Expression must be a number or string.");return new Wn(e.expressionCompiler.compile(n))}check(t){return!!t.evaluator.eval(this._expression)}}Wn.ID="Expression";class Hn extends qe{constructor(t){super(),this._condition=t}static fromJSONObject(t,e){if(!("condition"in t)||null==t.condition)throw new Error("Missing condition definition.");return new Hn(e.conditionFactory.fromJSON(t.condition))}check(t){return!this._condition.check(t)}}Hn.ID="Not";class Yn extends qe{constructor(t){super(),this._conditions=t}static fromJSONObject(t,e){if(!("conditions"in t)||!Array.isArray(t.conditions))throw new Error("Missing condition definitions.");return new Yn(e.conditionFactory.fromJSONArray(t.conditions))}check(t){for(let e of this._conditions)if(!e.check(t))return!1;return!0}}Yn.ID="All";class Xn extends qe{constructor(t){super(),this._conditions=t}static fromJSONObject(t,e){if(!("conditions"in t)||!Array.isArray(t.conditions))throw new Error("Missing condition definitions.");return new Xn(e.conditionFactory.fromJSONArray(t.conditions))}check(t){for(let e of this._conditions)if(e.check(t))return!0;return!1}}Xn.ID="Any";class Zn extends qe{constructor(t,e,n){super(),this._conditions=t,this._min=e,this._max=n}static fromJSONObject(t,e){if(!("conditions"in t)||!Array.isArray(t.conditions))throw new Error("Missing condition definitions.");const n=e.conditionFactory.fromJSONArray(t.conditions);let i,r;if("min"in t){if("number"!=typeof t.min&&"string"!=typeof t.min)throw new Error("min must be a valid number or expression string.");i=e.expressionCompiler.compile(t.min)}else i=e.expressionCompiler.compile(-1/0);if("max"in t){if("number"!=typeof t.max&&"string"!=typeof t.max)throw new Error("max must be a valid number or expression string.");r=e.expressionCompiler.compile(t.max)}else r=e.expressionCompiler.compile(1/0);return new Zn(n,i,r)}check(t){const e=t.evaluator.eval(this._min),n=t.evaluator.eval(this._max);let i=0;for(let e of this._conditions)e.check(t)&&i++;return i>=e&&i<=n}}Zn.ID="Some";var Qn=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class ti{constructor(t,e,n){this._exprCompiler=t,this._conditionFactory=e,this._actionFactory=n}load(t){return Qn(this,void 0,void 0,(function*(){return ve(t,(t=>this.loadFromString(t)))}))}loadFromString(t){return this.parseEvents(Ft(t)||{})}parseEvents(t){if(!Array.isArray(t))throw new Error("Expecting an array of event definitions.");return t.map((t=>this.parseEvent(t)))}parseEvent(t){if(null==t.id)throw new Error("Missing event id.");const e=t.id;if(null!=t.trigger&&"string"!=typeof t.trigger)throw new Error("Event trigger must be a string.");const n=t.trigger||"",i=Array.isArray(t.conditions)?t.conditions.map((t=>this._conditionFactory.fromJSON(t))):[];let r;if(null==t.probability)r=1;else if("number"==typeof t.probability)r=t.probability;else{if("string"!=typeof t.probability)throw new Error("Probability must either a number or a string expression.");r=this._exprCompiler.compile(t.probability)}const o=Array.isArray(t.exclusions)?t.exclusions:[];if(!Array.isArray(t.actions))throw new Error("Missing actions.");const s=new We(t.actions.map((t=>this._actionFactory.fromJSONObject(t)))),a=!!t.once,c=!!t.disabled,l="number"==typeof t.priority?t.priority:0;return new Ye(e,n,i,s,r,o,a,c,l)}}var ei=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class ni{constructor(t,e,n="",i=[]){this._id=t,this._duration=e,this._icon=n,this._effects=i}get id(){return this._id}get unlocalizedName(){return"status."+this.id}get unlocalizedDescription(){return this.unlocalizedName+".description"}get icon(){return this._icon}get duration(){return this._duration}getEffects(){return this._effects}}class ii extends Ie{constructor(t){super(),this._attributeRegistry=t}get name(){return"status"}loadStatus(t){return ei(this,void 0,void 0,(function*(){let e=yield ve(t,Ft);if(!e)return;if(!Array.isArray(e.status))throw new Error("Expecting an array of status definitions.");let n=e.status;for(let t of n){if("string"!=typeof t.id)throw new Error("Missing item id.");let e;e=Array.isArray(t.effects)?De(t.effects,this._attributeRegistry):[];let n="number"==typeof t.duration?t.duration:1/0,i="string"==typeof t.icon?t.icon:"";this.add(new ni(t.id,n,i,e))}console.log(`Successfully registered ${n.length} status.`)}))}}class ri extends ze{constructor(){super(...arguments),this._remainingTicks={}}add(t,e=1){if("string"==typeof t&&(t=this._registry.get(t)),1!==e)throw new Error("Count must be one.");null==this._items[t.id]&&(this._items[t.id]=[t,1],this._remainingTicks[t.id]=t.duration,this.dispatchChangeEvent(new Le(!1,t,0,1))),this._remainingTicks[t.id]=t.duration}remove(t,e=1){if("string"==typeof t&&(t=this._registry.get(t)),1!==e)throw new Error("Count must be one.");null!=this._items[t.id]&&(delete this._items[t.id],delete this._remainingTicks[t.id],this.dispatchChangeEvent(new Le(!1,t,0,1)))}clear(){super.clear(),this._remainingTicks={}}tick(){let t=[];for(let e in this._remainingTicks)--this._remainingTicks[e],0===this._remainingTicks[e]&&t.push(e);for(let e of t)this.remove(e)}decodeFromJson(t){if(null===t||!Array.isArray(t))throw new Error("Array expected.");this.clear();for(const e of t){if(!Array.isArray(e)||2!==e.length||"string"!=typeof e[0]||"number"!=typeof e[1])throw new Error("Each saved status data should be a two-element tuple of the status id string and the duration remaining.");const[t,n]=e;this.add(t),this._remainingTicks[t]=n<0?1/0:n}}encodeAsJson(){let t=new Array;for(const e in this._items){const n=this._remainingTicks[e];t.push([e,isFinite(n)?n:-1])}return t}}var oi=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};function si(){return Math.random().toString().substring(2)}class ai{constructor(t,e){this.state=t,this.endingType=e}}class ci{constructor(t,e){this._dataLoaded=!1,this._config=Object.assign({},t),this._actionProxy=e,this._attributeRegistry=new je,this._itemRegistry=new Pe(this._attributeRegistry),this._statusRegistry=new ii(this._attributeRegistry),this._inventory=new Ve(this._itemRegistry),this._statusTable=new ri(this._statusRegistry),this._variableStore=new Te,this._endGameState=sn.None,this._endingType="",this._random=new ln(null==this._config.initialRandomSeed?si():this._config.initialRandomSeed),this._eventEngine=new tn,this._expressionEngine=new on(this._variableStore,this._attributeRegistry,this._inventory,this._statusTable,this._random,this._eventEngine),this._conditionFactory=new Gn(this._expressionEngine),this._actionFactory=new Cn(this._conditionFactory,this._expressionEngine),this._executionContext={variableStore:this._variableStore,inventory:this._inventory,statusTable:this._statusTable,random:this._random,evaluator:this._expressionEngine,eventEngine:this._eventEngine,actionProxy:e,setEndGameState:(t,e)=>{this._endGameState=t,e&&(this._endingType=e)}}}get variableStore(){return this._variableStore}get random(){return this._random}get attributeRegistry(){return this._attributeRegistry}get itemRegistry(){return this._itemRegistry}get statusRegistry(){return this._statusRegistry}get inventory(){return this._inventory}get statusTable(){return this._statusTable}get actionProxy(){return this._actionProxy}get expressionEngine(){return this._expressionEngine}get eventEngine(){return this._eventEngine}loadGameData(){return oi(this,void 0,void 0,(function*(){if(this._dataLoaded)return;this._initFactories(),this._config.attributeDefinitionUrl?yield this._attributeRegistry.loadAttributes(this._config.attributeDefinitionUrl):console.warn("Missing attribute definitions. No attributes loaded."),this._config.itemDefinitionUrl?yield this._itemRegistry.loadItems(this._config.itemDefinitionUrl):console.warn("Missing item definitions. No items loaded."),this._config.statusDefinitionUrl?yield this._statusRegistry.loadStatus(this._config.statusDefinitionUrl):console.warn("Missing status definitions. No status loaded.");const t=new ti(this._expressionEngine,this._conditionFactory,this._actionFactory);if(this._config.eventDefinitionUrl){const e=yield t.load(this._config.eventDefinitionUrl);this._eventEngine.registerEvents(e),console.log(`Successfully registered ${e.length} game events.`)}else console.warn("Missing event definitions. No events loaded.");this._dataLoaded=!0}))}_initFactories(){this._actionFactory.registerDeserializer(Sn),this._actionFactory.registerDeserializer(kn),this._actionFactory.registerDeserializer(Tn),this._actionFactory.registerDeserializer(In),this._actionFactory.registerDeserializer(Nn),this._actionFactory.registerDeserializer(On),this._actionFactory.registerDeserializer(Fn),this._actionFactory.registerDeserializer(Dn),this._actionFactory.registerDeserializer(Ln),this._actionFactory.registerDeserializer(zn),this._actionFactory.registerDeserializer(Rn),this._actionFactory.registerDeserializer(Kn),this._actionFactory.registerDeserializer($n),this._actionFactory.registerDeserializer(Mn),this._actionFactory.registerDeserializer(jn),this._actionFactory.registerDeserializer(Pn),this._actionFactory.registerDeserializer(Vn),this._actionFactory.registerDeserializer(Bn),this._actionFactory.registerDeserializer({ID:Un.ID,fromJSONObject:Un.fromJSONObject}),this._actionFactory.registerDeserializer(qn),this._actionFactory.registerDeserializer(Jn),this._conditionFactory.registerDeserializer(Wn),this._conditionFactory.registerDeserializer(Hn),this._conditionFactory.registerDeserializer(Yn),this._conditionFactory.registerDeserializer(Xn),this._conditionFactory.registerDeserializer(Zn),this._actionFactory.registerDeserializer(En)}start(t){return oi(this,void 0,void 0,(function*(){this._dataLoaded||(yield this.loadGameData()),this._variableStore.reset(),this._inventory.clear(),this._statusTable.clear(),this._endGameState=sn.None,t?this._random.reset(si()):this._random.reset(),this._eventEngine.reset(),this._eventEngine.trigger("Initialization",1,0)}))}tick(){return oi(this,void 0,void 0,(function*(){for(this._eventEngine.trigger("Tick",1,0);;){const t=yield this._eventEngine.processNextTrigger(this._executionContext);if(this._endGameState!==sn.None)return this.onGameEnd&&this.onGameEnd(this,new ai(this._endGameState,this._endingType)),void(yield this.start(this._endGameState===sn.Win));if(!t)break}this._statusTable.tick()}))}}class li{attachGui(t){this._guiGame=t}displayMessage(t,e,n,i){if(!this._guiGame)throw new Error("No attached GUI.");return this._guiGame.displayMessage(t,e,n,i)}displayChoices(t,e,n){if(!this._guiGame)throw new Error("No attached GUI.");return this._guiGame.displayChoices(t,e,n)}}class ui{constructor(t,e,n){this._ldict=t,this._variableStore=e,this._random=n}render(t){return t=t.replace(/\{\{(@?[a-z0-9$_.]+)(:\d+)?\}\}/gi,((t,e,n)=>{if("@"===e[0]){let n=e.substring(1);return this._evalSpecialVariable(n)||t}if(nn(e)){let i=this._variableStore.getVar(e,!1);return null==i?(console.log("Undefined variable "+e),t):null==n?i.toString():i.toFixed(parseInt(n.slice(1)))}return t})),function(t){let e=[],n="",i=0,r=0;for(;i<t.length;){if(!(t[i]in hi)){++i;continue}let o=t[i];if(i+1<t.length&&t[i+1]===o){i>r&&(n+=t.substring(r,i));let s=!1;e.length>0&&o===e[e.length-1]?(e.pop(),n+=hi[o][1],s=!0):0!==e.length&&"`"===e[e.length-1]||(e.push(t[i]),n+=hi[o][0],s=!0),i+=2,s&&(r=i)}else++i}i>r&&(n+=t.substring(r,i));for(;e.length>0;)n+=hi[e.pop()][1];return n}(t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"))}localizeAndRender(t){return this.render(this.localize(t))}localize(t){return this._ldict.translate(t)}getLocalizationDictionary(){return this._ldict}_evalSpecialVariable(t){if(nn(t))switch(t){case"seed":return this._random.seed;case"seedUrl":return`${window.location.protocol+"//"+window.location.host+window.location.pathname}#init_seed=${encodeURIComponent(this._random.seed)}`;default:return}}}const hi={"*":["<em>","</em>"],"#":["<strong>","</strong>"],_:['<span style="text-decoration: underline">',"</span>"],"`":["<code>","</code>"]};var di,fi=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};let pi={},mi=null===(di=document.getElementById("app_config"))||void 0===di?void 0:di.textContent;mi&&(pi=Object.assign({},JSON.parse(mi)));let gi=oe.parse(window.location.hash||"").init_seed;"string"==typeof gi&&(pi.initialRandomSeed=gi);new class{constructor(t,e){this._started=!1,this._config=e,this._container=t,this._actionProxy=new li,this._gameEngine=new ci(e,this._actionProxy),this._localizer=new Ee}start(){return fi(this,void 0,void 0,(function*(){var t;if(t=new wn,bn=t,this._started)throw new Error("App already started!");this._config.languageFileUrl?yield this._localizer.loadFrom(this._config.languageFileUrl):console.warn("Missing language file!");const e=new ui(this._localizer,this._gameEngine.variableStore,this._gameEngine.random);if(!this._config.guiDefinitionUrl)throw new Error("Missing GUI config file!");let n=yield ve(this._config.guiDefinitionUrl,Ft),i=new we(this._container,e,this._gameEngine,n);this._actionProxy.attachGui(i),this._gameEngine.onGameEnd=(t,e)=>{window.dispatchEvent(new CustomEvent("gameEnd",{detail:{state:e.state,endingType:e.endingType}}))},yield this._gameEngine.start(!1),this._config.debugConfig&&this._dumpDebugInfo(this._config.debugConfig);const r=()=>{setTimeout((()=>this._gameEngine.tick().then(r)),50)};r(),this._started=!0}))}_dumpDebugInfo(t){if(t.dumpTranslationKeys){const t=this._gameEngine.eventEngine.getEvents(),e=new Ue;for(let n of t)e.addAll(n.collectTranslationKeys());this._gameEngine.itemRegistry.forEach((t=>{this._localizer.addRequiredKey(t.unlocalizedName),this._localizer.addRequiredKey(t.unlocalizedDescription)})),this._gameEngine.statusRegistry.forEach((t=>{this._localizer.addRequiredKey(t.unlocalizedName),this._localizer.addRequiredKey(t.unlocalizedDescription)})),e.get().forEach((t=>this._localizer.addRequiredKey(t)));const n=this._localizer.dumpRequiredTranslationKeys();console.log(`# Required translation keys (${n.length}):\n${n.join("\n")}`);const i=this._localizer.dumpMissingTranslationKeys();console.log(`# Missing translation keys (${i.length}):\n${i.join("\n")}`);const r=this._localizer.dumpUnnecessaryTranslationKeys();console.log(`# Unnecessary translation keys (${r.length}):\n${r.join("\n")}`)}}}(document.body,pi).start().then((()=>{console.log("App started successfully.")}))})()})();
//# sourceMappingURL=app.bundle.js.map