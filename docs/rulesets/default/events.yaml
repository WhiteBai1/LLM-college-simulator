---
#event
- id: Init
  trigger: Initialization
  once: true
  actions:
    - id: UpdateVariableLimits
      updates:
        player.learn: [0,100]
        player.health: [0,100]
        player.grade: [0,100]
        player.EQ: [0,100]
        player.academicIntention: [0,100]
        player.technicIntention: [0,100]
        interview.score: [0,10]
    - id: UpdateVariables
      updates:
        elapsedWeek: 0
        week: 0
        semester: 1
        year: 1
        player.learn: 60
        player.health: 100
        player.grade: 60
        player.EQ: 60
        player.academicIntention: 0
        player.technicIntention: 0
        interview.score: 0
    

# main loop
- id: GameTick
  trigger: Tick
  actions:
    - id: UpdateVariables
      updates:
        week: week + 1 
        semester: floor((elapsedWeek - 1)/16) + 1
        year: floor((elapsedWeek - 1)/32) + 1
    - id: TriggerEvents
      triggers:
        - id: WeekBegin

#update attributes every weekBegin
- id: CommonVariableUpdates
  trigger: WeekBegin
  actions:
    - id: UpdateVariables
      updates:
        player.learn: min(max(player.learn + getAttributeValue('player.learnBoost') , 0), 100)
        player.health: min(max(player.health + getAttributeValue('player.healthBoost') , 0), 100)
        player.grade: min(max(player.grade + getAttributeValue('player.gradeBoost') , 0), 100)
        player.academicIntention: min(max(player.academicIntention + getAttributeValue('player.academicIntentionBoost'), 0), 100)
        player.technicIntention: min(max(player.technicIntention + getAttributeValue('player.technicIntentionBoost'), 0), 100)
    


#game beginning
- id: TheBeginning  
  trigger: WeekBegin
  priority: 10
  once: true
  actions:
    - id: DisplayMessage
      message: message.beginningCollege
      confirm: message.ok
    - id: SetStatus
      statusId: firstYearOrientation
      on: true

#choose the goal every week
- id: WeeklyGoal
  trigger: WeekBegin
  priority: 1
  actions:
    - id: DisplayChoices
      message: message.weeklyGoal
      confirm: message.ok
      choices:

        - message: message.goalStudy
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalStudyResult
              confirm: message.great
            - id: UpdateVariables
              updates:
                player.grade: player.grade + 3
                player.learn: player.learn + 3
                player.health: player.health - 4
                player.academicIntention: player.academicIntention + 2
            - id: Random
              condition: player.health < 75
              probability: 0.4
              groups:
                - weight: 1
                  actions:
                    - id: DisplayMessage
                      message: message.goalResearchTired
                      confirm: message.sad
                    - id: UpdateVariables
                      updates:
                        player.grade: player.grade - 5
                        player.academicIntention: player.academicIntention -3
                        player.technicIntention: player.technicIntention -3
                        player.learn: player.learn - 7
                        player.health: player.health - 5

        - message: message.goalRest
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalRestResult
              confirm: message.cool
            - id: UpdateVariables
              updates:
                player.grade: player.grade - 2
                player.learn: player.learn - 2
                player.health: player.health +10
                player.EQ: player.EQ + 3      

        - message: message.goalResearch
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalResearchResult
              confirm: message.encouraging
            - id: UpdateVariables
              updates:
                player.learn: player.learn + 3
                player.technicIntention: player.technicIntention + 3
                player.academicIntention: player.academicIntention + 3
                player.health: player.health - 5
                player.grade: player.grade - 2
            - id: Random
              probability: 0.3
              groups:
                - weight: 0.3
                  actions:
                    - id: DisplayMessage
                      message: message.goalResearchBreakthrough
                      confirm: message.excited
                    - id: UpdateVariables
                      updates:
                        player.grade: player.grade + 3
                        player.academicIntention: player.academicIntention + 5
                        player.technicIntention: player.technicIntention + 5
                        player.learn: player.learn + 5
                - weight: 0.25
                  conditions: 
                    - id: Expression
                      expression: player.health < 75       
                  actions:
                    - id: DisplayMessage
                      message: message.goalResearchTired
                      confirm: message.ok
                    - id: UpdateVariables
                      updates:
                        player.grade: player.grade - 5
                        player.academicIntention: player.academicIntention -3
                        player.technicIntention: player.technicIntention -3
                        player.learn: player.learn - 7
                        player.health: player.health - 5
              
        - message: message.goalCrazyPlay
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalCrazyPlayResult
              confirm: message.cool
            - id: UpdateVariables
              updates:
                player.health: player.health + 5   
                player.grade: player.grade - 10      
                player.EQ: player.EQ + 5             
                player.learn: player.learn - 7
                player.academicIntention: player.academicIntention - 5
                player.technicIntention: player.technicIntention - 5
            - id: Random
              probability: 0.3
              groups:
                - weight: 0.3
                  actions:
                    - id: DisplayMessage
                      message: message.goalCrazyPlayTooMuch
                      confirm: message.unfortunate
                    - id: UpdateVariables
                      updates:
                        player.grade: player.grade - 10
                        player.health: player.health - 15

# high pressure and tired
- id: Burnout
  trigger: WeekBegin
  conditions:
    - id: Expression
      expression:  player.health < 40 && !hasStatus('burnout')
  actions:
    - id: DisplayMessage
      message: message.burnout
      confirm: message.sad
    - id: SetStatus
      statusId: burnout
      on: true
    - id: UpdateVariables
      updates:
        player.learn: player.learn - 8
        player.health: player.health - 8

- id: Tired
  trigger: WeekBegin
  conditions:
    - id: Expression
      expression: player.health < 70 && !hasStatus('tired') 
  actions:
    - id: SetStatus
      statusId: tired
      on: true
    - id: UpdateVariables
      updates:
        player.learn: player.learn - 4
        player.health: player.health - 4


- id: BounceBack
  trigger: WeekBegin
  conditions:
    - id: Expression
      expression: hasStatus('burnout') && player.health > 40
  actions:
    - id: DisplayMessage
      message: message.bounceBack
      confirm: message.encouraging
    - id: UpdateVariables
      updates:
        player.learnBoost: player.learnBoost + 5
        player.gradeBoost: player.gradeBoost + 3
    - id: SetStatus
      statusId: burnout
      on: false

- id: TiredBack
  trigger: WeekBegin
  conditions:
    - id: Expression
      expression: hasStatus('tired') && player.health > 75
  actions:
    - id: SetStatus
      statusId: tired
      on: false
    - id: UpdateVariables
      updates:
        player.learn: player.learn + 2


#speacial events

- id: MidtermExamComing
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 6 || week == 30
  actions:
    - id: SetStatus
      statusId: midtermsPressure
      on: true
    - id: DisplayMessage
      message: message.midtermComing
      confirm: message.ok


# week10: MidtermExam
- id: MidtermExam
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 8  || week == 32
  actions:
    - id: DisplayMessage
      message: message.midterm
      confirm: message.ok

    - id: Switch
      branches:
        - condition: (player.grade * 0.4 + player.learn * 0.3 + player.academicIntention * 0.2 + player.health * 0.1) / 10 >= 8
          actions:
            - id: DisplayMessage
              message: message.examExcellent
              confirm: message.great
            - id: UpdateVariables
              updates:
                player.grade: player.grade + 12
                player.learn: player.learn + 5
                player.health: player.health + 3

        - condition: (player.grade * 0.4 + player.learn * 0.3 + player.academicIntention * 0.2 + player.health * 0.1) / 10 >= 6
          actions:
            - id: DisplayMessage
              message: message.examPassed
              confirm: message.ok
            - id: UpdateVariables
              updates:
                player.grade: player.grade + 6

        - condition: "true"
          actions:
            - id: DisplayMessage
              message: message.examFailed
              confirm: message.sucks
            - id: UpdateVariables
              updates:
                player.grade: player.grade - 8
                player.health: player.health - 2

#week18: FinaltermExamComing
- id: FinaltermExamComing
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 14 || week == 38
  actions:
    - id: SetStatus
      statusId: FinaltermsPressure
      on: true
    - id: DisplayMessage
      message: message.FinaltermComing
      confirm: message.ok

# week10: FinaltermExam
- id: FinalMidtermExam
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 16 || week == 40
  actions:
    - id: DisplayMessage
      message: message.Finalterm
      confirm: message.ok

    - id: Switch
      branches:
        - condition: (player.grade * 0.4 + player.learn * 0.3 + player.academicIntention * 0.2 + player.health * 0.1) / 10 >= 8
          actions:
            - id: DisplayMessage
              message: message.examExcellent
              confirm: message.great
            - id: UpdateVariables
              updates:
                player.grade: player.grade + 12
                player.learn: player.learn + 5
                player.health: player.health + 3

        - condition: (player.grade * 0.4 + player.learn * 0.3 + player.academicIntention * 0.2 + player.health * 0.1) / 10 >=  6
          actions:
            - id: DisplayMessage
              message: message.examPassed
              confirm: message.ok
            - id: UpdateVariables
              updates:
                player.grade: player.grade + 6

        - condition: "true"
          actions:
            - id: DisplayMessage
              message: message.examFailed
              confirm: message.sucks
            - id: UpdateVariables
              updates:
                player.grade: player.grade - 8
                player.health: player.health - 2


# SummerInternship
- id: SummerInternship
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 17 
  actions:
    - id: SetStatus
      statusId: summerInternship
      on: true
    - id: DisplayChoices
      message: message.summerEvent
      confirm: message.ok
      choices:
        - message: message.goalStudy
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalStudyResult
              confirm: message.great
            - id: UpdateVariables
              updates:
                player.grade: player.grade + 3
                player.learn: player.learn + 2
                player.health: player.health + 1
                player.academicIntention: player.academicIntention + 2
            - id: Random
              condition: player.health < 75
              probability: 0.4
              groups:
                - weight: 1
                  actions:
                    - id: DisplayMessage
                      message: message.goalResearchTired
                      confirm: message.excited
                    - id: UpdateVariables
                      updates:
                        player.grade: player.grade - 5
                        player.academicIntention: player.academicIntention -3
                        player.technicIntention: player.technicIntention -3
                        player.learn: player.learn - 7
                        player.health: player.health - 5

        - message: message.goalRest
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalRestResult
              confirm: message.cool
            - id: UpdateVariables
              updates:
                player.grade: player.grade - 2
                player.learn: player.learn - 2
                player.health: player.health +8
                player.EQ: player.EQ + 3      
        
        - message: message.choiceInternship
          confirm: message.ok
          actions:
            # 计算成功概率（属性70% + 运气30%）
            - id: DisplayMessage
              message: "你将参加一个模拟面试，请认真回答。"
              confirm: message.ok
            - id: UpdateVariables
              updates:
                interview.score: 0
            - id: EAInterview
              npcId: 4
              npcName: "面试官"

            - id: Switch
              branches:
                #success
                - condition: (player.technicIntention + player.learn * 0.8 + player.EQ*0.1 + player.academicIntention*0.5 ) >= 60
                  probability: 0.75
                  actions:
                    - id: DisplayMessage
                      message: message.internshipSuccess
                      confirm: message.great
                    - id: UpdateVariables
                      updates:
                        player.technicIntention: player.technicIntention + 16
                        player.health: player.health - 15
                        player.EQ: player.EQ + 3
                        week: week+6
                    - id: SetStatus
                      statusId: successInternship
                      on: true
                # fail
                - condition: "true"
                  actions:
                    - id: DisplayMessage
                      message: message.internshipFailed
                      confirm: message.sucks
                    - id: UpdateVariables
                      updates:
                        player.technicIntention: player.technicIntention + 2
                        player.health: player.health - 3
                        week: week +2
                    - id: SetStatus
                      statusId: failInternship
                      on: true

        - message: message.choiceResearch
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: "你将参加一个模拟面试，请认真回答。"
              confirm: message.ok
            - id: UpdateVariables
              updates:
                interview.score: 0
            - id: EAInterview
              npcId: 1
              npcName: "导师"
            - id: Switch
              branches:
                # +
                - condition: (player.academicIntention  + player.learn * 0.8 + player.EQ*0.1 + player.technicIntention*0.4 )  >= 60
                  probability: 0.75
                  actions:
                    - id: DisplayMessage
                      message: message.researchSuccess
                      confirm: message.great
                    - id: UpdateVariables
                      updates:
                        player.academicIntention: player.academicIntention + 16
                        player.grade: player.grade + 8
                        player.health: player.health - 15
                        week: week +6
                    - id: SetStatus
                      statusId: successResearch
                      on: true
                # fail
                - condition: "true"
                  actions:
                    - id: DisplayMessage
                      message: message.researchFailed
                      confirm: message.sucks
                    - id: UpdateVariables
                      updates:
                        player.academicIntention: player.academicIntention + 8
                        player.health: player.health - 15
                        player.learn: player.learn -8
                        week: week + 8
                    - id: SetStatus
                      statusId: failResearch
                      on: true

- id: newterm
  trigger: WeekBegin
  priority: 6
  conditions: 
    - id: Expression
      expression: week == 25
  actions: 
    - id: DisplayMessage
      message: message.newterm
      confirm: message.excited



- id: GameEnd
  trigger: WeekBegin
  priority: 10
  conditions: 
    - id: Expression
      expression: week > 40   
  actions:
    - id: EAPersonalReport
      message: "大一结束了！根据您一年的表现，正在为您生成一个个性化报告..."
      npcId: 4
      npcName: "导师"
      prompt: "大学期末总结报告"
      confirm: message.ok
    - id: EndGame
      message: message.end
      confirm: message.restart
      winning: true
    # - id: TriggerEvent
      # eventId: EndReport


- id: Test_ExamPrep
  trigger: WeekBegin
  priority: 4
  conditions:
    - id: Expression
      expression: week == 6  
  actions:
    - id: DisplayMessage
      message: "学长要来传授考试经验了。"
      confirm: message.ok
    - id: EAExamPrep
      npcId: 3
      prompt: "期中/期末考试复习与应考要点"
      npcName: "学长"

# - id: Test_Interview
#   trigger: WeekBegin
#   priority: 4
#   conditions:
#     - id: Expression
#       expression: week == 21
#   actions:
#     - id: DisplayMessage
#       message: "你将参加一个模拟面试，请认真回答。"
#       confirm: message.ok
#     - id: UpdateVariables
#       updates:
#         interview.score: 0
#     - id: EAInterview
#       npcId: 4
#       npcName: "面试官"



- id: WeeklyDailyQuote
  trigger: WeekBegin
  priority: 8
  actions:
    - id: SetItemAmounts
      updates:
        dailyQuote1: 0
        dailyQuote2: 0
        dailyQuote3: 0
        dailyQuote4: 0
        dailyQuote5: 0
        dailyQuote6: 0
        dailyQuote7: 0
        dailyQuote8: 0
        dailyQuote9: 0

    # 2. 随机获得一条金句
    - id: Random
      groups:
        - weight: 1
          actions:
            - id: GiveItem
              itemId: dailyQuote1
              amount: 1
        - weight: 1
          actions:
            - id: GiveItem
              itemId: dailyQuote2
              amount: 1
        - weight: 1
          actions:
            - id: GiveItem
              itemId: dailyQuote3
              amount: 1
        - weight: 1
          actions:
            - id: GiveItem
              itemId: dailyQuote4
              amount: 1
        - weight: 1
          actions:
            - id: GiveItem
              itemId: dailyQuote5
              amount: 1
        - weight: 1
          actions:
            - id: GiveItem
              itemId: dailyQuote6
              amount: 1
        - weight: 1
          actions:
            - id: GiveItem
              itemId: dailyQuote7
              amount: 1
        - weight: 1
          actions:
            - id: GiveItem
              itemId: dailyQuote8
              amount: 1
        - weight: 1
          actions:
            - id: GiveItem
              itemId: dailyQuote9
              amount: 1