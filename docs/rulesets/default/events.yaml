---
#event
- id: Init
  trigger: Initialization
  once: true
  actions:
    - id: UpdateVariableLimits
      updates:
        learnBoost: [0,100]
        healthBoost: [0,100]
        player.gradeBoost: [0,100]
        player.EQBoost: [0,100]
        player.academicIntention: [0,100]
        player.technicIntention: [0,100]
        interview.score: [0,10]
    - id: UpdateVariables
      updates:
        elapsedWeek: 0
        week: 0
        semester: 1
        year: 1
        learnBoost: 60
        healthBoost: 100
        player.gradeBoost: 60
        player.EQBoost: 60
        player.academicIntention: 0
        player.technicIntention: 0
        interview.score: 0
    - id: SetStatus
      statusId: firstYearOrientation
      on: true

# main loop
- id: GameTick
  trigger: Tick
  actions:
    - id: UpdateVariables
      updates:
        week: week + 1 
        semester: floor((elapsedWeek - 1)/16) + 1
        year: floor((elapsedWeek - 1)/32) + 1
    - id: TriggerEvents
      triggers:
        - id: WeekBegin

#update attributes every weekBegin
- id: CommonVariableUpdates
  trigger: WeekBegin
  actions:
    - id: UpdateVariables
      updates:
        learnBoost: min(max(learnBoost + getAttributeValue('learnBoost') * 0.1, 0), 100)
        healthBoost: min(max(healthBoost + getAttributeValue('healthBoost') * 0.05, 0), 100)
        player.gradeBoost: min(max(player.gradeBoost + getAttributeValue('player.gradeBoost') * 0.05, 0), 100)
        player.academicIntention: min(max(player.academicIntention + getAttributeValue('player.academicIntention'), 0), 100)
        player.technicIntention: min(max(player.technicIntention + getAttributeValue('player.technicIntention'), 0), 100)



#game beginning
- id: TheBeginning  
  trigger: WeekBegin
  priority: 6
  once: true
  actions:
    - id: DisplayMessage
      message: message.beginningCollege
      confirm: message.ok

#choose the goal every week
- id: WeeklyGoal
  trigger: WeekBegin
  priority: 1
  actions:
    - id: DisplayChoices
      message: message.weeklyGoal
      confirm: message.ok
      choices:

        - message: message.goalStudy
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalStudyResult
              confirm: message.great
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost + 3
                learnBoost: learnBoost + 3
                healthBoost: healthBoost - 4
                player.academicIntention: player.academicIntention + 2
            - id: Random
              condition: player.healthBoost < 75
              probability: 0.4
              groups:
                - weight: 1
                  actions:
                    - id: DisplayMessage
                      message: message.goalResearchTired
                      confirm: message.sad
                    - id: UpdateVariables
                      updates:
                        player.gradeBoost: player.gradeBoost - 5
                        player.academicIntention: player.academicIntention -3
                        player.technicIntention: player.technicIntention -3
                        learnBoost: learnBoost - 7
                        healthBoost: healthBoost - 5

        - message: message.goalRest
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalRestResult
              confirm: message.cool
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost - 2
                learnBoost: learnBoost - 2
                healthBoost: healthBoost +8
                player.EQBoost: player.EQBoost + 3      

        - message: message.goalResearch
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalResearchResult
              confirm: message.encouraging
            - id: UpdateVariables
              updates:
                learnBoost: learnBoost + 3
                player.technicIntention: player.technicIntention + 3
                player.academicIntention: player.academicIntention + 3
                healthBoost: healthBoost - 5
                player.gradeBoost: player.gradeBoost - 2
            - id: Random
              probability: 0.3
              groups:
                - weight: 0.3
                  actions:
                    - id: DisplayMessage
                      message: message.goalResearchBreakthrough
                      confirm: message.excited
                    - id: UpdateVariables
                      updates:
                        player.gradeBoost: player.gradeBoost + 3
                        player.academicIntention: player.academicIntention + 5
                        player.technicIntention: player.technicIntention + 5
                        learnBoost: learnBoost + 5
                - weight: 0.25
                  conditions: 
                    - id: Expression
                      expression: healthBoost < 75       
                  actions:
                    - id: DisplayMessage
                      message: message.goalResearchTired
                      confirm: message.ok
                    - id: UpdateVariables
                      updates:
                        player.gradeBoost: player.gradeBoost - 5
                        player.academicIntention: player.academicIntention -3
                        player.technicIntention: player.technicIntention -3
                        learnBoost: learnBoost - 7
                        healthBoost: healthBoost - 5
              
        - message: message.goalCrazyPlay
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalCrazyPlayResult
              confirm: message.cool
            - id: UpdateVariables
              updates:
                healthBoost: healthBoost + 5   
                player.gradeBoost: player.gradeBoost - 10      
                player.EQBoost: player.EQBoost + 5             
                learnBoost: learnBoost - 7
                player.academicIntention: player.academicIntention - 5
                player.technicIntention: player.technicIntention - 5
            - id: Random
              probability: 0.3
              groups:
                - weight: 0.3
                  actions:
                    - id: DisplayMessage
                      message: message.goalCrazyPlayTooMuch
                      confirm: message.unfortunate
                    - id: UpdateVariables
                      updates:
                        player.gradeBoost: player.gradeBoost - 10
                        healthBoost: healthBoost - 15

# high pressure and tired
- id: Burnout
  trigger: WeekBegin
  probability: 0.15
  conditions:
    - id: Expression
      expression: learnBoost > 80 && healthBoost < 40
  actions:
    - id: DisplayMessage
      message: message.burnout
      confirm: message.sad
    - id: SetStatus
      statusId: burnout
      on: true
    - id: UpdateVariables
      updates:
        learnBoost: learnBoost - 10
        healthBoost: healthBoost - 10

#speacial events

- id: MidtermExamComing
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 8 || week == 36
  actions:
    - id: SetStatus
      statusId: midtermsPressure
      on: true
    - id: DisplayMessage
      message: message.midtermComing
      confirm: message.ok


# week10: MidtermExam
- id: MidtermExam
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 10  || week == 38
  actions:
    - id: DisplayMessage
      message: message.midterm
      confirm: message.ok

    - id: Switch
      branches:
        - condition: (player.gradeBoost * 0.4 + learnBoost * 0.3 + player.academicIntention * 0.2 + healthBoost * 0.1) / 10 >= 8
          actions:
            - id: DisplayMessage
              message: message.examExcellent
              confirm: message.great
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost + 12
                learnBoost: learnBoost + 5
                healthBoost: healthBoost + 3

        - condition: (player.gradeBoost * 0.4 + learnBoost * 0.3 + player.academicIntention * 0.2 + healthBoost * 0.1) / 10 >= 6
          actions:
            - id: DisplayMessage
              message: message.examPassed
              confirm: message.ok
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost + 6

        - condition: "true"
          actions:
            - id: DisplayMessage
              message: message.examFailed
              confirm: message.sucks
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost - 8
                healthBoost: healthBoost - 2

#week18: FinaltermExamComing
- id: FinaltermExamComing
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 18 || week == 46
  actions:
    - id: SetStatus
      statusId: FinaltermsPressure
      on: true
    - id: DisplayMessage
      message: message.FinaltermComing
      confirm: message.ok

# week10: FinaltermExam
- id: FinalMidtermExam
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 20 || week == 48
  actions:
    - id: DisplayMessage
      message: message.Finalterm
      confirm: message.ok

    - id: Switch
      branches:
        - condition: (gradeBoost * 0.4 + learnBoost * 0.3 + player.academicIntention * 0.2 + healthBoost * 0.1) / 10 >= 8
          actions:
            - id: DisplayMessage
              message: message.examExcellent
              confirm: message.great
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost + 12
                learnBoost: learnBoost + 5
                healthBoost: healthBoost + 3

        - condition: (player.gradeBoost * 0.4 + learnBoost * 0.3 + player.academicIntention * 0.2 + healthBoost * 0.1) / 10 >= 6
          actions:
            - id: DisplayMessage
              message: message.examPassed
              confirm: message.ok
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost + 6

        - condition: "true"
          actions:
            - id: DisplayMessage
              message: message.examFailed
              confirm: message.sucks
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost - 8
                player.healthBoost: player.healthBoost - 2


# SummerInternship
- id: SummerInternship
  trigger: WeekBegin
  priority: 6
  conditions:
    - id: Expression
      expression: week == 21 
  actions:
    - id: SetStatus
      statusId: summerInternship
      on: true
    - id: DisplayChoices
      message: message.summerEvent
      confirm: message.ok
      choices:
        - message: message.goalStudy
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalStudyResult
              confirm: message.great
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost + 3
                learnBoost: learnBoost + 2
                healthBoost: healthBoost + 1
                player.academicIntention: player.academicIntention + 2
            - id: Random
              condition: healthBoost < 75
              probability: 0.4
              groups:
                - weight: 1
                  actions:
                    - id: DisplayMessage
                      message: message.goalResearchTired
                      confirm: message.excited
                    - id: UpdateVariables
                      updates:
                        player.gradeBoost: player.gradeBoost - 5
                        player.academicIntention: player.academicIntention -3
                        player.technicIntention: player.technicIntention -3
                        learnBoost: learnBoost - 7
                        healthBoost: healthBoost - 5

        - message: message.goalRest
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: message.goalRestResult
              confirm: message.cool
            - id: UpdateVariables
              updates:
                player.gradeBoost: player.gradeBoost - 2
                learnBoost: learnBoost - 2
                healthBoost: healthBoost +8
                player.EQBoost: player.EQBoost + 3      
        
        - message: message.choiceInternship
          confirm: message.ok
          actions:
            # 计算成功概率（属性70% + 运气30%）
            - id: DisplayMessage
              message: "你将参加一个模拟面试，请认真回答。"
              confirm: message.ok
            - id: UpdateVariables
              updates:
                interview.score: 0
            - id: EAInterview
              npcId: 4
              npcName: "面试官"

            - id: Switch
              branches:
                #success
                - condition: (player.technicIntention * 0.5 + learnBoost * 0.5 + player.EQBoost*0.1 + player.academicIntention*0.1 ) >= 75
                  probability: 0.75
                  actions:
                    - id: DisplayMessage
                      message: message.internshipSuccess
                      confirm: message.great
                    - id: UpdateVariables
                      updates:
                        player.technicIntention: player.technicIntention + 16
                        healthBoost: healthBoost - 15
                        player.EQBoost: player.EQBoost + 3
                        week: week+8
                    - id: SetStatus
                      statusId: successInternship
                      on: true
                # fail
                - condition: "true"
                  actions:
                    - id: DisplayMessage
                      message: message.internshipFailed
                      confirm: message.sucks
                    - id: UpdateVariables
                      updates:
                        player.technicIntention: player.technicIntention + 2
                        healthBoost: healthBoost - 3
                        week: week +2
                    - id: SetStatus
                      statusId: failInternship
                      on: true

        - message: message.choiceResearch
          confirm: message.ok
          actions:
            - id: DisplayMessage
              message: "你将参加一个模拟面试，请认真回答。"
              confirm: message.ok
            - id: UpdateVariables
              updates:
                interview.score: 0
            - id: EAInterview
              npcId: 4
              npcName: "面试官"
            - id: Switch
              branches:
                # +
                - condition: (player.academicIntention * 0.5 + learnBoost * 0.5 + player.EQBoost*0.1 + player.technicIntention*0.1 )  >= 75
                  probability: 0.75
                  actions:
                    - id: DisplayMessage
                      message: message.researchSuccess
                      confirm: message.great
                    - id: UpdateVariables
                      updates:
                        player.academicIntention: player.academicIntention + 16
                        player.gradeBoost: player.gradeBoost + 8
                        healthBoost: healthBoost - 15
                        week: week +8
                    - id: SetStatus
                      statusId: successResearch
                      on: true
                # fail
                - condition: "true"
                  actions:
                    - id: DisplayMessage
                      message: message.researchFailed
                      confirm: message.sucks
                    - id: UpdateVariables
                      updates:
                        player.academicIntention: player.academicIntention + 8
                        healthBoost: healthBoost - 15
                        learnBoost: learnBoost -8
                        week: week + 8
                    - id: SetStatus
                      statusId: failResearch
                      on: true

- id: newterm
  trigger: WeekBegin
  priority: 6
  conditions: 
    - id: Expression
      expression: week == 29
  actions: 
    - id: DisplayMessage
      message: message.newterm
      confirm: message.excited

# lyingflat bounceback
# - id: BounceBack
#   trigger: WeekBegin
#   probability: 0.2
#   conditions:
#     - id: Expression
#       expression: hasStatus('rest') && player.healthBoost > 80
#   actions:
#     - id: DisplayMessage
#       message: message.bounceBack
#       confirm: message.encouraging
#     - id: UpdateVariables
#       updates:
#         player.learnBoost: player.learnBoost + 8
#         player.gradeBoost: player.gradeBoost + 3



# game end:      
# - id: EndReport
#   trigger: GameEnd
#   actions:
#     - id: DisplayMessage
#       message: message.endReport
#       confirm: message.ok
#     - id: AIGenerateReport
#       prompt: |
#         请根据以下玩家数据生成一份中文报告：
#         - 学业成绩：{{ player.academic }}
#         - 健康状态：{{ player.health }}
#         - 社交活跃：{{ player.social }}
#         - 科研投入：{{ player.research }}
#         - 玩乐次数：{{ player.playCount }}
#         - 实习经历：{{ player.internship }}
#         要求写一段150字左右的《大学四年总结报告》，
#         内容包括总体表现、性格特征、大学生活亮点和未来展望。
#     - id: DisplayAIResult
#       label: "你的大学总结报告如下："

- id: GameEnd
  trigger: WeekBegin
  priority: 10
  conditions: 
    - id: Expression
      expression: week > 48   
  actions:
    - id: DisplayMessage
      message: message.end
      confirm: message.ok
    # - id: TriggerEvent
      # eventId: EndReport


- id: Test_ExamPrep
  trigger: WeekBegin
  priority: 4
  conditions:
    - id: Expression
      expression: week == 8  
  actions:
    - id: DisplayMessage
      message: "学长要来传授考试经验了。"
      confirm: message.ok
    - id: EAExamPrep
      npcId: 3
      prompt: "期中/期末考试复习与应考要点"
      npcName: "学长"

# - id: Test_Interview
#   trigger: WeekBegin
#   priority: 4
#   conditions:
#     - id: Expression
#       expression: week == 21
#   actions:
#     - id: DisplayMessage
#       message: "你将参加一个模拟面试，请认真回答。"
#       confirm: message.ok
#     - id: UpdateVariables
#       updates:
#         interview.score: 0
#     - id: EAInterview
#       npcId: 4
#       npcName: "面试官"